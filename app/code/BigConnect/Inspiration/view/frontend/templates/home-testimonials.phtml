<?php
/** @var \BigConnect\Inspiration\Block\Gallery $block */
$items = $block->getGalleryItems(); // oƒçak√°vame array s image, rating, review/customer_name, country_code, atƒè.
if (!$items) {
    return;
}
?>

<style>
/* hide native scrollbar */
.bc-slider {
    scrollbar-width: none;           /* Firefox */
    -ms-overflow-style: none;        /* IE/Edge legacy */
}
.bc-slider::-webkit-scrollbar {
    display: none;                   /* Chrome/Safari */
}

/* prevent text selection while dragging */
.bc-dragging, .bc-dragging * {
    user-select: none !important;
    cursor: grabbing !important;
}
</style>

<section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">

        <!-- Header -->
        <div class="text-center mb-16">
            <div class="inline-flex items-center gap-2 mb-4 px-3 py-1.5 rounded-full border"
                 style="background-color:#f0f4f1;color:#7e9b84;border-color:#7e9b84;">
                <span class="text-sm">üì∑</span>
                <span class="text-sm font-semibold">Fotky od z√°kazn√≠kov</span>
            </div>

            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
                ƒåo hovoria na≈°i z√°kazn√≠ci?
            </h2>
            <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                Z√°kazn√≠ci z cel√©ho sveta n√°m d√¥veruj√∫ - Franc√∫zsko ‚Ä¢ Nemecko ‚Ä¢ Chorv√°tsko ‚Ä¢ ƒåesko ‚Ä¢ Rak√∫sko
            </p>
        </div>

        <!-- Slider wrapper -->
        <div
            class="relative"
            x-data="bcTestimonialsSlider()"
            x-init="init()"
        >

            <!-- arrows -->
            <button type="button"
                    class="absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center transition-colors border-2 border-primary text-primary hover:bg-primary hover:text-white"
                    @click="scrollPrev"
                    aria-label="<?= $block->escapeHtmlAttr(__('Previous')) ?>">
                ‚Äπ
            </button>

            <button type="button"
                    class="absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center transition-colors border-2 border-primary text-primary hover:bg-primary hover:text-white"
                    @click="scrollNext"
                    aria-label="<?= $block->escapeHtmlAttr(__('Next')) ?>">
                ‚Ä∫
            </button>

            <!-- "slider" (scroll-snap) -->
            <div class="px-2 md:px-8">
                <div class="bc-slider flex gap-6 overflow-x-auto pb-4 snap-x snap-mandatory scroll-smooth"
                     style="-webkit-overflow-scrolling: touch;"
                     x-ref="slider"
                     :class="isDragging ? 'bc-dragging' : 'cursor-grab'"
                     @scroll.passive="updateThumb()"
                     @pointerdown.capture="startDrag($event)"
                     @click.capture="maybeBlockClick($event)">
                    <?php foreach ($items as $item): ?>
                        <?php
                        $imgUrl = (string)($item['image_url'] ?? '');
                        $rating = (int)($item['rating'] ?? 5);
                        $rating = max(1, min(5, $rating));

                        $text = (string)($item['review'] ?? $item['text'] ?? '');
                        $author = (string)($item['customer_name'] ?? $item['author'] ?? 'Z√°kazn√≠k');
                        $country = strtoupper((string)($item['country_code'] ?? ''));
                        $location = (string)($item['location'] ?? $country);

                        $flagUrl = (string)($item['country_flag'] ?? '');
                        ?>

                        <div class="snap-start shrink-0 w-[85%] sm:w-[60%] md:w-[38%] lg:w-[32%]">
                            <div class="group bg-white rounded-xl overflow-hidden border border-gray-200 hover:shadow-xl transition-all duration-300 flex flex-col">

                                <!-- Photo -->
                                <div class="relative h-80 overflow-hidden bg-gray-100 order-1">
                                    <img src="<?= $block->escapeUrl($imgUrl) ?>"
                                         alt="<?= $block->escapeHtmlAttr('St√¥l od ' . $author) ?>"
                                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />

                                    <div class="absolute top-4 right-4 bg-white rounded-full px-3 py-1.5 shadow-lg flex items-center gap-1.5">
                                        <span class="text-green-600">‚úî</span>
                                        <span class="text-xs font-semibold text-gray-700">Overen√©</span>
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="p-6 order-2">
                                    <!-- Rating -->
                                    <div class="flex gap-1 mb-4">
                                        <?php for ($i=1; $i<=5; $i++): ?>
                                            <span class="<?= $i <= $rating ? 'text-yellow-400' : 'text-gray-200' ?>">‚òÖ</span>
                                        <?php endfor; ?>
                                    </div>

                                    <!-- Text -->
                                    <p class="text-gray-700 leading-relaxed mb-6 min-h-[120px]">
                                        "<?= $block->escapeHtml($text) ?>"
                                    </p>

                                    <!-- Author -->
                                    <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                                        <div>
                                            <div class="font-semibold text-gray-900 flex items-center gap-2">
                                                <?php if ($flagUrl): ?>
                                                    <img src="<?= $block->escapeUrl($flagUrl) ?>"
                                                         alt="<?= $block->escapeHtmlAttr($location) ?>"
                                                         class="w-6 h-6 rounded-full object-cover" />
                                                <?php endif; ?>
                                                <?= $block->escapeHtml($author) ?>
                                            </div>
                                            <div class="text-sm text-gray-500"><?= $block->escapeHtml($location) ?></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>

            <!-- CUSTOM BAR -->
            <div
                class="relative w-full mt-6 cursor-pointer select-none px-2 md:px-8"
                x-ref="bar"
                @click="barClick($event)"
            >
                <div class="w-full bg-gray-200 rounded-full overflow-hidden h-2 md:h-3 relative">
                    <div
                        class="absolute h-2 md:h-3 rounded-full transition-colors cursor-grab active:cursor-grabbing bg-primary hover:bg-primary-darker"
                        :style="`left:${thumbLeft}%; width:${thumbWidth}%;`"
                        @pointerdown.prevent="startThumbDrag($event)"
                    ></div>
                </div>
            </div>

        </div>

        <!-- Trust message -->
        <div class="mt-16 text-center">
            <div class="inline-flex items-center gap-3 sm:gap-6 md:gap-8 px-4 py-4 sm:px-6 sm:py-5 md:px-8 md:py-6 rounded-xl mx-auto"
                 style="background-color:#f0f4f1;">
                <div>
                    <div class="text-xl sm:text-2xl md:text-3xl font-bold mb-1" style="color:#7e9b84;">5000+</div>
                    <div class="text-[10px] sm:text-xs md:text-sm text-gray-600 whitespace-nowrap">Spokojn√Ωch z√°kazn√≠kov</div>
                </div>
                <div class="w-px h-8 sm:h-10 md:h-12 bg-gray-300"></div>
                <div>
                    <div class="text-xl sm:text-2xl md:text-3xl font-bold mb-1" style="color:#7e9b84;">4.9/5</div>
                    <div class="text-[10px] sm:text-xs md:text-sm text-gray-600 whitespace-nowrap">Priemern√© hodnotenie</div>
                </div>
                <div class="w-px h-8 sm:h-10 md:h-12 bg-gray-300"></div>
                <div>
                    <div class="text-xl sm:text-2xl md:text-3xl font-bold mb-1" style="color:#7e9b84;">98%</div>
                    <div class="text-[10px] sm:text-xs md:text-sm text-gray-600 whitespace-nowrap">Odpor√∫ƒçaj√∫ ƒèalej</div>
                </div>
            </div>
        </div>

    </div>
</section>

<script>
document.addEventListener('alpine:init', () => {
    if (Alpine.data.__bcTestimonialsSliderRegistered) return;
    Alpine.data.__bcTestimonialsSliderRegistered = true;

    Alpine.data('bcTestimonialsSlider', () => ({
        thumbLeft: 0,
        thumbWidth: 0,

        isDragging: false,
        dragStartX: 0,
        dragStartScrollLeft: 0,
        dragMoved: false,
        dragThresholdPx: 6,

        isThumbDragging: false,

        init() {
            this.$nextTick(() => {
                this.updateThumb();
                window.addEventListener('resize', () => this.updateThumb(), { passive: true });
            });
        },

        scrollPrev() {
            this.$refs.slider.scrollBy({ left: -this.$refs.slider.clientWidth, behavior: 'smooth' });
        },
        scrollNext() {
            this.$refs.slider.scrollBy({ left: this.$refs.slider.clientWidth, behavior: 'smooth' });
        },

        updateThumb() {
            const el = this.$refs.slider;
            const maxScroll = el.scrollWidth - el.clientWidth;

            if (maxScroll <= 0) {
                this.thumbLeft = 0;
                this.thumbWidth = 100;
                return;
            }

            this.thumbWidth = Math.max(12, (el.clientWidth / el.scrollWidth) * 100);

            const left = (el.scrollLeft / maxScroll) * (100 - this.thumbWidth);
            this.thumbLeft = Math.min(Math.max(left, 0), 100 - this.thumbWidth);
        },

        barClick(e) {
            const barRect = this.$refs.bar.getBoundingClientRect();
            const x = e.clientX - barRect.left;
            const pct = x / barRect.width;

            const el = this.$refs.slider;
            const maxScroll = el.scrollWidth - el.clientWidth;
            if (maxScroll <= 0) return;

            el.scrollLeft = Math.max(0, Math.min(maxScroll, pct * maxScroll));
            this.updateThumb();
        },

        startThumbDrag(e) {
            this.isThumbDragging = true;

            const onMove = (ev) => {
                if (!this.isThumbDragging) return;

                const barRect = this.$refs.bar.getBoundingClientRect();
                const x = ev.clientX - barRect.left;
                const pct = x / barRect.width;

                const el = this.$refs.slider;
                const maxScroll = el.scrollWidth - el.clientWidth;
                if (maxScroll <= 0) return;

                el.scrollLeft = Math.max(0, Math.min(maxScroll, pct * maxScroll));
                this.updateThumb();
            };

            const onUp = () => {
                this.isThumbDragging = false;
                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', onUp);
                window.removeEventListener('pointercancel', onUp);
            };

            window.addEventListener('pointermove', onMove, { passive: true });
            window.addEventListener('pointerup', onUp, { passive: true });
            window.addEventListener('pointercancel', onUp, { passive: true });
        },

        startDrag(e) {
            if (e.button !== undefined && e.button !== 0) return;
            if (this.isThumbDragging) return;

            this.isDragging = true;
            this.dragMoved = false;

            this.dragStartX = e.clientX;
            this.dragStartScrollLeft = this.$refs.slider.scrollLeft;

            const onMove = (ev) => {
                if (!this.isDragging) return;

                const dx = ev.clientX - this.dragStartX;
                if (Math.abs(dx) > this.dragThresholdPx) this.dragMoved = true;

                this.$refs.slider.scrollLeft = this.dragStartScrollLeft - dx;
                this.updateThumb();
            };

            const onUp = () => {
                this.isDragging = false;

                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', onUp);
                window.removeEventListener('pointercancel', onUp);

                setTimeout(() => { this.dragMoved = false; }, 0);
            };

            window.addEventListener('pointermove', onMove, { passive: true });
            window.addEventListener('pointerup', onUp, { passive: true });
            window.addEventListener('pointercancel', onUp, { passive: true });

            e.preventDefault();
        },

        maybeBlockClick(e) {
            if (this.dragMoved) {
                e.preventDefault();
                e.stopPropagation();
            }
        },
    }));
});
</script>
