<?php
/** @var \BigConnect\ProductSlider\Block\Widget\ProductSlider $block */
/** @var \Magento\Framework\Escaper $escaper */
$viewModel = $block->getViewModel();
$config = [
    'page_size' => $block->getPageSize(),
    'period_days' => $block->getPeriodDays(),
    'only_in_stock' => $block->isOnlyInStock(),
    'only_visible' => $block->isOnlyVisible(),
];
$items = $viewModel->getItems($block->getSourceCode(), $config);

if ($items === []) {
    return;
}

$accentColor = $block->getAccentColor();
$badgeText = $block->getTitleBadge();
$wishlistEnabled = $block->isWishlistEnabled();
$addToCartEnabled = $block->isAddToCartEnabled();
?>
<section class="py-20 bg-white">
    <div class="max-w-7xl mx-auto px-4">
        <div class="text-center mb-12">
            <?php if ($badgeText) : ?>
                <div class="inline-block px-4 py-2 text-white rounded-full mb-4" style="background-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;">
                    <?= $escaper->escapeHtml($badgeText) ?>
                </div>
            <?php endif; ?>
            <?php if ($block->getTitle()) : ?>
                <h2 class="text-3xl md:text-4xl font-bold mb-4">
                    <?= $escaper->escapeHtml($block->getTitle()) ?>
                </h2>
            <?php endif; ?>
            <?php if ($block->getSubtitle()) : ?>
                <p class="text-lg max-w-2xl mx-auto text-gray-600">
                    <?= $escaper->escapeHtml($block->getSubtitle()) ?>
                </p>
            <?php endif; ?>
        </div>

        <div class="relative" x-data="productSlider()">
            <button
                type="button"
                class="absolute -left-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center transition-colors border-2"
                style="border-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>; color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;"
                @click="scrollPrev"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Predchádzajúci')) ?>"
            >
                <span class="text-2xl leading-none">&lsaquo;</span>
            </button>
            <button
                type="button"
                class="absolute -right-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white shadow-lg flex items-center justify-center transition-colors border-2"
                style="border-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>; color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;"
                @click="scrollNext"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Ďalší')) ?>"
            >
                <span class="text-2xl leading-none">&rsaquo;</span>
            </button>

            <div
                class="flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory pb-4"
                x-ref="slider"
            >
                <?php foreach ($items as $product) : ?>
                    <div class="snap-start shrink-0 w-72 sm:w-80 lg:w-72 xl:w-80">
                        <div class="bg-white rounded-xl sm:rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 group border border-gray-100 flex flex-col h-full">
                            <div class="relative overflow-hidden aspect-square bg-white">
                                <a href="<?= $escaper->escapeUrl($product->getProductUrl()) ?>" class="block">
                                    <img
                                        src="<?= $escaper->escapeUrl($viewModel->getImageUrl($product)) ?>"
                                        alt="<?= $escaper->escapeHtmlAttr($product->getName()) ?>"
                                        class="w-full h-full object-contain p-4 sm:p-8 group-hover:scale-110 transition-transform duration-500"
                                        loading="lazy"
                                    />
                                </a>
                                <div class="absolute top-2 left-2 sm:top-4 sm:left-4">
                                    <span class="text-white px-2 py-0.5 sm:px-3 sm:py-1 rounded-full text-xs sm:text-sm" style="background-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;">
                                        <?= $escaper->escapeHtml($viewModel->getSourceLabel($block->getSourceCode())) ?>
                                    </span>
                                </div>
                                <?php if ($viewModel->hasDiscount($product)) : ?>
                                    <div class="absolute top-2 right-2 sm:top-4 sm:right-4">
                                        <span class="bg-red-500 text-white px-2 py-0.5 sm:px-3 sm:py-1 rounded-full font-bold text-xs sm:text-sm">
                                            <?= $escaper->escapeHtml($viewModel->getDiscountPercent($product)) ?>
                                        </span>
                                    </div>
                                <?php endif; ?>
                                <?php if ($wishlistEnabled) : ?>
                                    <?php $wishlistParams = $viewModel->getWishlistPostParams($product); ?>
                                    <?php if ($wishlistParams) : ?>
                                        <button
                                            type="button"
                                            class="absolute bottom-2 right-2 sm:bottom-4 sm:right-4 bg-white/90 backdrop-blur-sm p-2 sm:p-3 rounded-full shadow-lg opacity-0 group-hover:opacity-100 transition-opacity hover:text-white"
                                            style="--wishlist-accent: <?= $escaper->escapeHtmlAttr($accentColor) ?>;"
                                            data-post='<?= $escaper->escapeHtmlAttr($wishlistParams) ?>'
                                            aria-label="<?= $escaper->escapeHtmlAttr(__('Pridať do obľúbených')) ?>"
                                            x-data
                                            x-on:mouseenter="$el.style.backgroundColor = '<?= $escaper->escapeJs($accentColor) ?>'"
                                            x-on:mouseleave="$el.style.backgroundColor = ''"
                                        >
                                            <span class="block text-base">♥</span>
                                        </button>
                                    <?php endif; ?>
                                <?php endif; ?>
                            </div>
                            <div class="p-3 sm:p-5 flex flex-col flex-1">
                                <h3 class="font-semibold text-sm sm:text-base mb-2 sm:mb-4 min-h-[2.5rem] line-clamp-2">
                                    <a href="<?= $escaper->escapeUrl($product->getProductUrl()) ?>" class="hover:underline">
                                        <?= $escaper->escapeHtml($product->getName()) ?>
                                    </a>
                                </h3>
                                <div class="flex items-center gap-1.5 sm:gap-2 mb-3 sm:mb-4">
                                    <span class="font-bold text-base sm:text-lg" style="color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;">
                                        <?= $escaper->escapeHtml($viewModel->getFormattedPrice($product)) ?>
                                    </span>
                                    <?php if ($viewModel->hasDiscount($product)) : ?>
                                        <span class="text-gray-400 line-through text-xs sm:text-sm">
                                            <?= $escaper->escapeHtml($viewModel->getFormattedOriginalPrice($product)) ?>
                                        </span>
                                    <?php endif; ?>
                                </div>
                                <?php if ($addToCartEnabled) : ?>
                                    <?php $postParams = $viewModel->getAddToCartPostParams($product); ?>
                                    <form data-role="tocart-form" action="<?= $escaper->escapeUrl($postParams['action']) ?>" method="post" class="mt-auto">
                                        <?php foreach ($postParams['data'] as $name => $value) : ?>
                                            <input type="hidden" name="<?= $escaper->escapeHtmlAttr($name) ?>" value="<?= $escaper->escapeHtmlAttr((string)$value) ?>" />
                                        <?php endforeach; ?>
                                        <?= $block->getBlockHtml('formkey') ?>
                                        <button
                                            type="submit"
                                            class="w-full text-white font-bold py-3 sm:py-4 text-xs sm:text-sm rounded-lg transition-colors"
                                            style="background-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;"
                                        >
                                            <?= $escaper->escapeHtml(__('Pridať do košíka')) ?>
                                        </button>
                                    </form>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        </div>

        <?php if ($block->getViewAllUrl()) : ?>
            <div class="text-center mt-12">
                <a
                    href="<?= $escaper->escapeUrl($block->getViewAllUrl()) ?>"
                    class="inline-flex items-center justify-center border-2 px-8 py-4 font-semibold rounded-lg transition-colors"
                    style="border-color: <?= $escaper->escapeHtmlAttr($accentColor) ?>; color: <?= $escaper->escapeHtmlAttr($accentColor) ?>;"
                >
                    <?= $escaper->escapeHtml($block->getViewAllLabel()) ?>
                </a>
            </div>
        <?php endif; ?>
    </div>
</section>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('productSlider', () => ({
            scrollPrev() {
                this.$refs.slider.scrollBy({ left: -this.$refs.slider.clientWidth, behavior: 'smooth' });
            },
            scrollNext() {
                this.$refs.slider.scrollBy({ left: this.$refs.slider.clientWidth, behavior: 'smooth' });
            }
        }));
    });
</script>
