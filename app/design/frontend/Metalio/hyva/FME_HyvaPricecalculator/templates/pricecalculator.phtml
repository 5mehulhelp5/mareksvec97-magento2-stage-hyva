<?php
/**
 * FME Pricecalculator (Hyvä) – Tailwind + AlpineJS slider (auto podľa FME min/max)
 * FIX: započítanie ceny ostatných custom options (ohyb/diery/atď.) do výslednej ceny
 */

$_helper = $this->helper('FME\Pricecalculator\Helper\Data');
if (!$_helper->isEnabledInFrontend()) { return; }

$helper = $block->pricecalculatorHelper;
$store  = $block->storeManager->getStore();

$currencyCode   = $store->getCurrentCurrency()->getCode();
$_product       = $block->getProduct();
$prodType       = $_product->getTypeId();

$productFinalPrice  = (float) $_product->getFinalPrice();   // bez DPH
$productIncTaxPrice = (float) $block->getPriceIncTax();     // s DPH
$customOptions      = $_product->getOptions();

// odhad sadzby DPH len pre zobrazenie
$taxRate = 0.0;
if ($productFinalPrice > 0 && $productIncTaxPrice != $productFinalPrice) {
    $taxRate = (($productIncTaxPrice - $productFinalPrice) * 100) / $productFinalPrice;
}

$_pc = $block->getPcLoadedData();
if (!$_pc) { return; }

// jednotková cena (môže byť "0,1")
$pcUnitPriceRaw = (string) $_pc->getPcUnitPrice();

// fallback ak jednotková cena prázdna
$unitPriceFallback = ($pcUnitPriceRaw === '' || $pcUnitPriceRaw === '0' || $pcUnitPriceRaw === '0,0' || $pcUnitPriceRaw === '0.0')
    ? $productFinalPrice
    : null;

// jednotky a pravidlá
$inputUnit   = (string) $_pc->getPcInputUnits();
$outputUnit  = (string) $_pc->getPcOutputUnits();
$measureBy   = (string) $_pc->getPcMeasureBy();
$fieldOptions= $helper->getFieldOptions($_pc); // obsahuje min/max z FME „Pricing Limit“
$pricingRule = $block->getProductPricingRule($_pc);

// labely
switch ($measureBy) {
    case 'area':
        $areaVolLabel    = __('Area');
        $outputUnitLabel = __('Square %1', $outputUnit);
        break;
    case 'volume':
        $areaVolLabel    = __('Volume');
        $outputUnitLabel = $outputUnit;
        break;
    case 'weight':
        $areaVolLabel    = __('Weight');
        $outputUnitLabel = $outputUnit;
        break;
    default:
        $areaVolLabel    = __($measureBy);
        $outputUnitLabel = $outputUnit;
        break;
}

// 1D konverzia – helper už zohľadňuje power podľa measureBy
$unitConversion    = (float) $helper->unitConversion($inputUnit, $outputUnit, $measureBy);
$digitsAfterDecimal= (int) $helper->digitAfterDecimal();

$showBasePrice     = (bool) $helper->showBasePrice();
$showDiscountPrice = (bool) $helper->showDiscountPrice();
$discountTitle     = (string) $helper->getDiscountTitle();

/**
 * Mapa obmedzení IBA z FME fieldOptions:
 * - ak má pole min/max -> považujeme za rozmer -> slider + validácia + výpočet
 * - inak ignorujeme pre výpočet
 */
$optionRestrictions = [];
foreach ($customOptions as $option) {
    $title = (string) $option->getTitle();
    if (!isset($fieldOptions[$title])) continue;

    $min = isset($fieldOptions[$title]['min']) ? (float) $fieldOptions[$title]['min'] : null;
    $max = isset($fieldOptions[$title]['max']) ? (float) $fieldOptions[$title]['max'] : null;

    if ($min === null && $max === null) continue;

    $optionRestrictions['options_' . $option->getId() . '_text'] = [
        'min'   => $min !== null ? $min : 0,
        'max'   => $max !== null ? $max : 0,
        'title' => $title,
    ];
}
if (empty($optionRestrictions)) { return; }

// preklady názvov pre UI
$optionTranslations = [];
foreach ($customOptions as $option) {
    $title = (string) $option->getTitle();
    $optionTranslations[$title] = (string) __($title);
}

// i18n správy do JS
$msgRangeTpl = (string) __('Please enter a value between %1 and %2.');
$baseUrlJs   = $store->getBaseUrl();

// farba značky a ikona (téma)
$brandPrimary = '#586cac';
$iconUrl = $block->getViewFileUrl('FME_HyvaPricecalculator::images/measurement.svg');
?>

<style>
:root { --brand-primary: <?= $brandPrimary ?>; }
input[type="range"].range-slider{
  height:12px; border-radius:9999px; appearance:none; background:#e5e7eb;
}
input[type="range"].range-slider::-webkit-slider-thumb{
  appearance:none; width:20px; height:20px; border-radius:9999px;
  background: var(--brand-primary); border:2px solid #fff; box-shadow:0 0 0 1px rgba(0,0,0,.05);
  cursor:pointer; margin-top:-6px;
}
input[type="range"].range-slider::-moz-range-thumb{
  width:20px; height:20px; border-radius:9999px; background: var(--brand-primary); border:2px solid #fff; cursor:pointer;
}
input[type="range"].range-slider::-webkit-slider-runnable-track,
input[type="range"].range-slider::-moz-range-track{
  height:12px; border-radius:9999px;
}
</style>

<div x-data="productCustomOptionsCalculator()" class="w-full" x-init="init()">
  <div id="calculations" class="ml-6 mt-0 z-[0] relative">
    <div class="rounded-2xl border border-t-[0] rounded-t-[0] border-slate-200 p-3 bg-white/70 shadow-sm backdrop-blur-sm max-w-max">
      <div class="flex items-center gap-3">
        <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-xl" aria-hidden="true">
          <img src="<?= $block->escapeUrl($iconUrl) ?>" class="block h-7 w-7" alt="Area icon">
        </div>
        <div class="min-w-0 flex-1">
          <div class="flex items-center gap-2">
            <span class="text-xs uppercase tracking-wide text-gray-500">
              <?= $block->escapeHtml($areaVolLabel) ?>
            </span>
          </div>
          <div class="mt-0.5 text-xl font-semibold leading-none">
            <span x-text="`${areaM2} m²`">0 m²</span>
          </div>
          <div class="mt-0.5 text-sm text-gray-500">
            <span x-text="`(${areaCm2} cm²)`">(0 cm²)</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
  Alpine.data('productCustomOptionsCalculator', () => ({
    // ===== server data =====
    prodType: "configurable",
    currencyCode: "EUR",
    areaVolLabel: "Plocha",
    outputUnitLabel: "Square\u0020cm",
    pricingRule: {"discount":{"min_limit":"0.00","max_limit":"0.00"},"size":{"min_limit":"0.00","max_limit":"0.00"},"by":"area","type":"fixed"},
    optionRestrictions: {"options_5817_text":{"min":30,"max":295,"title":"Width"},"options_5818_text":{"min":30,"max":145,"title":"Height"}},
    optionTranslations: {"Width":"&Scaron;&iacute;rka","Height":"V&yacute;&scaron;ka","Ohyb okrajov 20mm":"Ohyb okrajov 20mm","Diery po krajoch 5mm":"Diery po krajoch 5mm"},
    msgRangeTpl: "Please\u0020enter\u0020a\u0020value\u0020between\u0020\u00251\u0020and\u0020\u00252.",
    baseUrl: "https\u003A\u002F\u002Fdev.metalio.sk\u002F",

    baseExcl: 60,
    unitPriceRaw: "0.0100",
    unitPriceFallback: null,
    unitConversion: 1,
    taxRate: 0,
    digitsAfterDecimal: 1,
    showBasePrice: true,
    showDiscountPrice: true,

    dimensionsLabel: "Rozmery",
    friendlyNames: {},

    // ===== state =====
    optionValues: {},
    optionValidity: {},
    calculatedArea: 0,
    discount: 0,
    totalIncl: 0,
    measureBy: "area",
    inputUnit: "cm",
    areaM2: 0,
    areaCm2: 0,

    // ===== scheduling FIX (bitka Hyvä vs náš výpočet) =====
    recalcTimer: null,
    recalcDelayMs: 220, // ak treba: 180-350

    scheduleRecalc(extraDelay = 0) {
      if (this.recalcTimer) clearTimeout(this.recalcTimer);

      const delay = (this.recalcDelayMs || 0) + (extraDelay || 0);

      this.recalcTimer = setTimeout(() => {
        // nech Hyvä stihne dorátať DOM + cenu -> 2 render tiky
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            try { this.calculatePrice(); } catch (e) {}
          });
        });
      }, Math.max(0, delay));
    },

    scheduleRecalcFast() {
      // pre písanie do inputu - menší delay
      this.scheduleRecalc(-120); // 220-120 = 100ms
    },

    // jednotková cena z parenta – default pre návrat
    unitPriceDefault: (function () {
      const raw = String("0.0100" || '');
      const fb  = Number(null || 0);
      const n   = parseFloat(raw.replace(',', '.'));
      return Number.isFinite(n) && n > 0 ? String(n) : String(fb);
    })(),

    // ===== utils =====
    parseNumber(str, fallback) {
      if (str === null || str === undefined || str === '') return Number(fallback || 0);
      const n = parseFloat(String(str).replace(',', '.'));
      return Number.isFinite(n) ? n : Number(fallback || 0);
    },
    roundToDecimal(number, decimals) {
      const factor = Math.pow(10, decimals);
      return Math.round(number * factor) / factor;
    },
    formatMoney(value) {
      try {
        return new Intl.NumberFormat(
          document.documentElement.lang || undefined,
          { style: 'currency', currency: this.currencyCode, minimumFractionDigits: 2 }
        ).format(Number(value || 0));
      } catch (e) {
        return Number(value || 0).toFixed(2) + ' ' + this.currencyCode;
      }
    },
    decodeHtmlEntities(s) {
      if (!s) return '';
      const t = document.createElement('textarea');
      t.innerHTML = s;
      return t.value;
    },
    decimalStep() {
      const d = Math.min(this.digitsAfterDecimal || 0, 2);
      return d === 2 ? 0.01 : (d === 1 ? 0.1 : 1);
    },
    brand() {
      const cssVar = getComputedStyle(document.documentElement).getPropertyValue('--brand-primary').trim();
      return cssVar || '#586cac';
    },
    updateRangeFill(rangeEl, min, max, value) {
      const perc = (max > min) ? ((value - min) / (max - min)) * 100 : 0;
      const brand = this.brand();
      rangeEl.style.background =
        `linear-gradient(to right, ${brand} 0%, ${brand} ${perc}%, #e5e7eb ${perc}%, #e5e7eb 100%)`;
    },

    // ===== pripočítaj ceny vybraných custom options (ohyb/diery/atď.) =====
    getSelectedOptionsPriceExcl() {
      let sum = 0;

      // radio/checkbox
      document.querySelectorAll('input.product-custom-option:checked').forEach(el => {
        const p =
          this.parseNumber(el.getAttribute('data-price-amount'), 0) ||
          this.parseNumber(el.getAttribute('data-price'), 0) ||
          this.parseNumber(el.getAttribute('price'), 0) ||
          this.parseNumber(el.dataset.priceAmount, 0) ||
          this.parseNumber(el.dataset.price, 0);
        sum += p;
      });

      // select custom options
      document.querySelectorAll('select.product-custom-option').forEach(sel => {
        const opt = sel.options[sel.selectedIndex];
        if (!opt) return;

        const p =
          this.parseNumber(opt.getAttribute('data-price-amount'), 0) ||
          this.parseNumber(opt.getAttribute('data-price'), 0) ||
          this.parseNumber(opt.dataset.priceAmount, 0) ||
          this.parseNumber(opt.dataset.price, 0);
        sum += p;
      });

      return sum;
    },

    // ===== init =====
    init() {
      // aby sme vedeli volať z global listenera
      window.__pc_calc = this;

      this.fixOptionLabels();
      this.setupOptionListeners();
      this.setupConfigurableListeners();

      // prvý prepočet nech prebehne až po inicializácii Hyvä
      this.scheduleRecalc(120);

      this.groupDimensionFields();
      this.placeAreaCardBelowGroup();
    },

    groupDimensionFields() {
      const fields = [];
      Object.keys(this.optionRestrictions).forEach((optionId) => {
        const input = document.getElementById(optionId);
        if (!input) return;
        const field = this.fieldContainerFor(input);
        if (field && !fields.includes(field)) fields.push(field);
      });
      if (!fields.length) return;

      let group = document.getElementById('dimensions-group');
      if (!group) {
        group = document.createElement('section');
        group.id = 'dimensions-group';
        group.className = 'mt-6 rounded-2xl border w-full border-slate-200 bg-white/70 shadow-sm z-[1]';

        const header = document.createElement('div');
        header.className = 'flex items-center gap-2 border-b border-slate-200 px-4 py-3';
        header.innerHTML = `
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-md bg-[var(--brand-primary)] text-white text-[10px] font-semibold">m&sup2;</span>
          <span class="text-sm font-medium text-slate-700">${this.dimensionsLabel}</span>
        `;

        const list = document.createElement('div');
        list.className = 'dim-list grid grid-cols-1 sm:grid-cols-2 sm:flex gap-4 p-4';

        group.append(header, list);
      }

      const first = fields[0];
      first.parentNode.insertBefore(group, first);

      const list = group.querySelector('.dim-list');
      fields.forEach((field) => {
        if (field.dataset.grouped === '1') return;
        field.dataset.grouped = '1';
        list.appendChild(field);
      });
    },

    placeAreaCardBelowGroup() {
      const group = document.getElementById('dimensions-group');
      if (!group) return;
      const cardRoot = this.$root;
      group.insertAdjacentElement('afterend', cardRoot);
    },

    fieldContainerFor(input) {
      return input.closest('.field')
          || (input.closest('.control') ? input.closest('.control').parentElement : null)
          || input.parentElement;
    },

    fixOptionLabels() {
      document.querySelectorAll('input[id^="options_"][id$="_text"]').forEach(input => {
        const optionId = input.id;
        const label = document.querySelector(`label[for="${optionId}"]`);
        if (!label || label.dataset.i18nFixed === '1') return;

        const isDim = !!this.optionRestrictions[optionId];

        const flat = this.decodeHtmlEntities(label.textContent || '').replace(/\s+/g,' ').trim();
        const starPresent = /\*/.test(flat) || input.required || !!label.querySelector('.sup, .required');
        const unitMatch   = flat.match(/\(([^)]+)\)\s*$/);
        const unitFromTxt = unitMatch ? unitMatch[1].trim() : '';

        let baseName = flat.replace(/\s*\*\s*/g, ' ').replace(/\s*\([^)]+\)\s*$/,'').trim();

        const tKey = Object.keys(this.optionTranslations).find(
          k => k.toLowerCase() === String(baseName).toLowerCase()
        );
        const translatedBase = this.decodeHtmlEntities(
          (tKey ? this.optionTranslations[tKey] : this.optionTranslations[baseName]) ?? baseName
        );

        this.friendlyNames[optionId] = translatedBase;

        const finalUnit = isDim
          ? (unitFromTxt || this.inputUnit || '').trim()
          : (unitFromTxt || '').trim();

        if (isDim) {
          label.classList.add('hidden');
          input.setAttribute('aria-label', finalUnit ? `${translatedBase} (${finalUnit})` : translatedBase);
          label.dataset.i18nFixed = '1';
          return;
        }

        while (label.firstChild) label.removeChild(label.firstChild);
        const mainSpan = document.createElement('span');
        mainSpan.className = 'label__text';
        mainSpan.textContent = finalUnit ? `${translatedBase} (${finalUnit})` : translatedBase;
        label.appendChild(mainSpan);
        if (starPresent) {
          const star = document.createElement('span');
          star.className = 'sup text-sm';
          star.textContent = ' *';
          label.appendChild(star);
        }

        const sibEl = label.nextElementSibling;
        if (sibEl && (sibEl.classList.contains('required') || sibEl.classList.contains('sup'))) sibEl.remove();
        let sib = label.nextSibling;
        while (sib && sib.nodeType === Node.TEXT_NODE) {
          if (/(\(\s*[^)]+\s*\)|\*)/.test(sib.textContent)) {
            const rm = sib; sib = sib.nextSibling; rm.parentNode && rm.parentNode.removeChild(rm);
          } else break;
        }
        label.dataset.i18nFixed = '1';
      });
    },

    addFieldHeading(input, optionId, restr) {
      if (!restr) return;
      const field = this.fieldContainerFor(input);
      if (!field || field.dataset.headingAdded === '1') return;

      const title = this.friendlyNames[optionId] || '';
      const head = document.createElement('div');
      head.className = 'mb-1 flex items-center justify-between';
      head.innerHTML = `<span class="text-sm font-medium text-slate-700">${title}</span>`;
      field.insertBefore(head, input);
      field.dataset.headingAdded = '1';
    },

    updateAreaUnits(areaRawProduct) {
      const u = (this.inputUnit || '').toLowerCase();
      let toM = 1, toCm = 1;
      if (u.startsWith('mm')) { toM = 0.001; toCm = 0.1; }
      else if (u.startsWith('cm')) { toM = 0.01;  toCm = 1;  }
      else { toM = 1; toCm = 100; }

      const m2  = areaRawProduct * (toM * toM);
      const cm2 = areaRawProduct * (toCm * toCm);

      this.areaM2  = this.roundToDecimal(m2, 2);
      this.areaCm2 = this.roundToDecimal(cm2, Math.min(this.digitsAfterDecimal || 0, 2));
    },

    attachSlider(input, optionId, restr) {
      if (!restr) return;
      if (input.dataset.sliderAttached === '1') return;
      input.dataset.sliderAttached = '1';

      const step = this.decimalStep();
      const min  = Number.isFinite(restr.min) ? Number(restr.min) : 0;
      const max  = Number.isFinite(restr.max) ? Number(restr.max) : 1000;
      const unit = (this.inputUnit || '').trim();

      const wrap = document.createElement('div');
      wrap.className = 'mt-2';

      const range = document.createElement('input');
      range.type = 'range';
      range.className = 'w-full range-slider';
      range.min = String(min);
      range.max = String(max);
      range.step = String(step);

      const info = document.createElement('div');
      info.className = 'mt-1 flex justify-between text-xs text-gray-500';
      const fmt = (v) => this.roundToDecimal(v, this.digitsAfterDecimal);
      info.innerHTML = `<span>${fmt(min)} ${unit}</span><span>${fmt(max)} ${unit}</span>`;

      wrap.append(range, info);
      input.parentNode.insertBefore(wrap, input.nextSibling);

      const setValue = (val) => {
        let v = Number(val);
        if (!Number.isFinite(v)) v = min;
        v = Math.min(max, Math.max(min, v));
        v = this.roundToDecimal(v, this.digitsAfterDecimal);

        input.value = v;
        range.value = v;
        this.updateRangeFill(range, min, max, v);
        input.dispatchEvent(new Event('input', { bubbles: true }));
      };

      const start = input.value !== '' ? Number(String(input.value).replace(',', '.')) : min;
      setValue(start);

      range.addEventListener('input', e => setValue(e.target.value));
      input.addEventListener('input', () => {
        const raw = Number(String(input.value).replace(',', '.'));
        const v = Number.isFinite(raw) ? Math.min(max, Math.max(min, raw)) : min;
        range.value = v;
        this.updateRangeFill(range, min, max, v);
      });
      input.addEventListener('change', () => setValue(input.value));
    },

    setupOptionListeners() {
      const addToCartBtn = document.getElementById('product-addtocart-button');

      // ===== FIX: prepočítaj aj po zmene radio/checkbox/select (ohyb/diery) =====
      // Pozor: tu musí byť klasická function, aby sme vedeli chytiť this cez window.__pc_calc
      if (!window.__pc_options_listener_added) {
        window.__pc_options_listener_added = true;

        document.addEventListener('change', function (e) {
          const t = e.target;
          if (!t) return;

          // custom options (radio/checkbox/select) => nech Hyvä spraví svoje a potom my
          if (
            t.classList &&
            t.classList.contains('product-custom-option') &&
            !(t.id && t.id.endsWith('_text') && t.id.startsWith('options_'))
          ) {
            try { window.__pc_calc && window.__pc_calc.scheduleRecalc(); } catch (err) {}
          }
        }, true);
      }

      document.querySelectorAll('input[id^="options_"][id$="_text"]').forEach(input => {
        const optionId = input.id;
        const restr = this.optionRestrictions[optionId];

        if (!restr) {
          input.addEventListener('input', () => this.scheduleRecalcFast());
          input.addEventListener('change', () => this.scheduleRecalc());
          return;
        }

        if (!this.optionValues[optionId]) this.optionValues[optionId] = 0;

        let errorEl = input.nextElementSibling;
        if (!errorEl || !errorEl.classList.contains('option-error')) {
          errorEl = document.createElement('div');
          errorEl.classList.add('option-error');
          errorEl.className = 'option-error text-red-600 text-xs mt-1';
          input.parentNode.insertBefore(errorEl, input.nextSibling);
        }

        const initVal = parseFloat(String(input.value).replace(',', '.'));
        this.optionValues[optionId] = Number.isFinite(initVal) ? initVal : (Number.isFinite(restr.min) ? restr.min : 0);
        this.optionValidity[optionId] = true;

        input.addEventListener('input', (e) => {
          const val = parseFloat(String(e.target.value).replace(',', '.')) || 0;

          if ((Number.isFinite(restr.min) && val < restr.min) || (Number.isFinite(restr.max) && val > restr.max)) {
            const minTxt = Number.isFinite(restr.min) ? restr.min : 0;
            const maxTxt = Number.isFinite(restr.max) ? restr.max : 0;
            errorEl.textContent = this.msgRangeTpl.replace('%1', minTxt).replace('%2', maxTxt);
            e.target.classList.add('error');
            this.optionValidity[optionId] = false;
          } else {
            errorEl.textContent = '';
            e.target.classList.remove('error');
            this.optionValidity[optionId] = true;
          }

          this.optionValues[optionId] = val;

          // namiesto immediate výpočtu -> plánovane, aby Hyvä stihla DOM
          this.scheduleRecalcFast();

          const hasInvalid = Object.values(this.optionValidity).includes(false);
          if (addToCartBtn) {
            addToCartBtn.disabled = hasInvalid;
            addToCartBtn.classList.toggle('opacity-50', hasInvalid);
            addToCartBtn.classList.toggle('cursor-not-allowed', hasInvalid);
          }
        });

        input.addEventListener('change', () => this.scheduleRecalc());

        this.addFieldHeading(input, optionId, restr);
        this.attachSlider(input, optionId, restr);
      });

      // prvý výpočet s delay
      this.scheduleRecalc(120);
    },

    // ===== configurable =====
    setupConfigurableListeners() {
      if (this.prodType !== 'configurable') return;
      const fireUpdate = (id) => { if (id) this.updatePriceFromChild(id); };

      window.addEventListener('configurable-selection-changed', (e) => {
        const id = e?.detail?.productIndex || e?.detail?.productId; fireUpdate(id);
      });
      window.addEventListener('configurable-variation-changed', (e) => {
        const id = e?.detail?.productId || e?.detail?.productIndex; fireUpdate(id);
      });
      window.addEventListener('configurable-update-price', (e) => {
        const id = e?.detail?.productId; fireUpdate(id);
      });

      const hidden = document.querySelector('input[name="selected_configurable_option"]');
      if (hidden) {
        let lastVal = hidden.value;
        const mo = new MutationObserver(() => {
          if (hidden.value && hidden.value !== lastVal) { lastVal = hidden.value; fireUpdate(hidden.value); }
        });
        mo.observe(hidden, { attributes: true, attributeFilter: ['value'] });
        hidden.addEventListener('change', () => fireUpdate(hidden.value));
      }

      document.querySelectorAll('select[name^="super_attribute"]').forEach(sel => {
        sel.addEventListener('change', () => { const id = this.pickChildId(); fireUpdate(id); });
      });
    },

    pickChildId() {
      const hidden = document.querySelector('input[name="selected_configurable_option"]');
      if (hidden && hidden.value) return hidden.value;
      return null;
    },

    updatePriceFromChild(childId) {
      const id = Number(childId);
      if (!id) return;

      const url = this.baseUrl + 'bcpricecalc/ajax/index';
      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
        body: JSON.stringify({ product_id: id })
      })
        .then(r => r.json())
        .then(data => {
          if (!data || !data.success) {
            console.error('Price fetch failed', data);
            return;
          }

          const excl = parseFloat(data.price);
          this.baseExcl = Number.isFinite(excl) ? excl : 0;

          if (data.price_incl !== undefined) {
            const incl = parseFloat(data.price_incl);
            if (Number.isFinite(incl) && Number.isFinite(excl) && excl > 0 && incl > excl) {
              this.taxRate = ((incl - excl) * 100) / excl;
            }
          }

          const upRaw = data?.pc?.unit_price;
          let upNum = NaN;
          if (typeof upRaw === 'number') upNum = upRaw;
          else if (typeof upRaw === 'string') upNum = parseFloat(upRaw.replace(',', '.'));

          if (Number.isFinite(upNum) && upNum > 0) {
            this.unitPriceRaw = String(upNum);
          } else {
            this.unitPriceRaw = this.unitPriceDefault;
          }

          // namiesto immediate -> naplánuj po Hyvä update
          this.scheduleRecalc(160);
        })
        .catch(console.error);
    },

    // ===== core výpočty =====
    calculateAreaRaw() {
      let v = 1;
      Object.keys(this.optionRestrictions).forEach((optionId) => {
        const num = parseFloat(this.optionValues[optionId]);
        v *= (Number.isFinite(num) ? num : 0);
      });
      return v;
    },

    calculateDiscount(areaOutUnits, unitPrice) {
      const rules = this.pricingRule;
      if (!rules || !rules.size || !rules.discount) return 0;

      const area = parseFloat(areaOutUnits);
      if (area < parseFloat(rules.size.min_limit)) return 0;

      if (area >= parseFloat(rules.size.min_limit) && area < parseFloat(rules.size.max_limit)) {
        return (rules.type === 'percent')
          ? (area * unitPrice) * (parseFloat(rules.discount.min_limit) / 100)
          : parseFloat(rules.discount.min_limit);
      }
      if (area >= parseFloat(rules.size.max_limit)) {
        return (rules.type === 'percent')
          ? (area * unitPrice) * (parseFloat(rules.discount.max_limit) / 100)
          : parseFloat(rules.discount.max_limit);
      }
      return 0;
    },

    applyTax(excl) {
      return this.taxRate > 0 ? excl * (1 + (this.taxRate / 100)) : excl;
    },

    calculatePrice() {
      const areaRaw = this.calculateAreaRaw();
      this.updateAreaUnits(areaRaw);

      const areaOut = areaRaw * this.unitConversion;
      this.calculatedArea = this.roundToDecimal(areaOut, this.digitsAfterDecimal);

      let unitPrice = this.parseNumber(this.unitPriceRaw, null);
      if (!Number.isFinite(unitPrice) || unitPrice === 0) {
        unitPrice = Number(this.unitPriceFallback || 0);
      }

      const deltaExcl = (unitPrice * areaOut) - this.calculateDiscount(areaOut, unitPrice);

      // pripočítaj custom option príplatky (ohyb/diery...)
      const optionsExcl = this.getSelectedOptionsPriceExcl();

      const totalExcl = Number(this.baseExcl || 0) + optionsExcl + deltaExcl;

      this.totalIncl = this.applyTax(totalExcl);
      this.updatePriceDisplay();
    },

    updatePriceDisplay() {
      // cena v hlavnom price boxe (to čo si už prepisuješ)
      const priceEls = document.querySelectorAll('[x-html="getFormattedFinalPrice()"]');
      priceEls.forEach(el => { el.innerHTML = this.formatMoney(this.totalIncl); });
    }
  }));
});
</script>


