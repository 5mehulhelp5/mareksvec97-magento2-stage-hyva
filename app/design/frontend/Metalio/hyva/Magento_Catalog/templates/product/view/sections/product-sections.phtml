<?php
/**
 * Hyvä Themes - https://hyva.io
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Catalog\Block\Product\View\Details;
use Magento\Framework\Escaper;

/** @var Details $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

/** @var HeroiconsSolid $heroiconsSolid */
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

$divider = $block->getDivider() !== null ? $block->getDivider() : true;
$sectionIsOpen = '';
?>

<div x-data="initProductSections" id="product-long-description" class="py-3 px-0 scroll-mt-24">
    <!-- OVLÁDANIE SEKCIÍ (mobil + desktop) -->
    <div class="pb-6" x-show="items.length">
        

        <!-- DESKTOP/TABLET: tabs (zarovnanie zľava) -->
        <ul class="hidden md:flex items-center justify-start border-b gap-6 lg:gap-8 font-medium
                   overflow-x-auto scrollbar-none px-0"
            style="-ms-overflow-style:none; scrollbar-width:none;">
            <template x-for="tab in items" :key="tab.id">
                <li class="relative pb-2 shrink-0">
                    <button
                        type="button"
                        class="inline-flex items-center gap-1 transition"
                        :aria-current="currentOpen === tab.id ? 'true' : 'false'"
                        @click="openSectionItem(tab.id)"
                    >
                        <span
                            class="hover:text-slate-900 text-lg"
                            :class="currentOpen === tab.id ? 'text-slate-900 font-semibold' : 'text-slate-600'"
                            x-text="tab.dataset.name"
                        ></span>
                    </button>

                    <!-- primárny indikátor pod aktívnym tabom -->
                    <span
                        x-show="currentOpen === tab.id"
                        class="pointer-events-none absolute left-0 -bottom-px h-1 w-full bg-primary rounded-full"
                    ></span>
                </li>
            </template>
        </ul>
    </div>

    <!-- OBSAH SEKCIÍ -->
    <div
        x-ref="accordion"
        <?php if ($divider): ?>
        class="divide-y lg:divide-y-0"
        <?php endif; ?>
    >
        <?php
            $productSectionIndex = 0;
            foreach ($block->getGroupSortedChildNames('detailed_info', '') as $sectionName):
                /** @var \Magento\Framework\View\Element\AbstractBlock $sectionBlock */
                $sectionBlock = $block->getLayout()->getBlock($sectionName);
                $sectionHtml = (string) $sectionBlock->toHtml();
                $sectionTitle = $sectionBlock->getTitle() ?: $sectionName;
                $sectionId = str_replace('.', '-', $sectionBlock->getNameInLayout());
                if (empty(trim($sectionHtml))) {
                    continue;
                }
                if ($productSectionIndex === 0) {
                    $sectionIsOpen = $sectionId;
                }
        ?>
            <details
                id="<?= $escaper->escapeHtmlAttr($sectionId) ?>"
                data-name="<?= $escaper->escapeHtml($sectionTitle) ?>"
                class="group scroll-mt-8 lg:scroll-mt-24 "
                :open="sectionItemIsOpen"
            >
                <!-- HLAVIČKA PRE MOBIL (na desktop tabs vyššie) -->
                <summary
                    @click.prevent="openSectionItem('<?= $escaper->escapeJs($sectionId) ?>')"
                    class="flex [&::-webkit-details-marker]:hidden md:hidden w-full items-center justify-between py-3 text-lg font-bold text-xl border-b  group-open:border-none group-open:text-[#586cac]"
                >
                    <span><?= $escaper->escapeHtml($sectionTitle) ?></span>
                    <span class="transition-transform group-open:rotate-180">
                        <?= $heroiconsSolid->chevronDownHtml('', 20, 20, ["aria-hidden" => true]); ?>
                    </span>
                </summary>

                <div data-id="<?= $escaper->escapeHtmlAttr($sectionId) ?>" x-show="sectionItemIsOpen" x-collapse>
                    <div class="pb-3">
                        <?= /** @noEscape */ $sectionHtml ?>
                    </div>
                </div>
            </details>
        <?php
            $productSectionIndex++;
            endforeach;
        ?>
    </div>

    <script>
        function initProductSections() {
            return {
                items: [],
                currentOpen: '<?= /** @noEscape */ $sectionIsOpen ?>',
                init() {
                    // naplniť zoznam tabs z <details> prvkov
                    this.items = [...this.$refs.accordion.children]
                        .filter(el => el.tagName && el.tagName.toLowerCase() === 'details')
                        .map(el => ({ id: el.id, dataset: { name: el.dataset.name } }));
                },
                openSectionItem(id) {
                    this.currentOpen = id || this.currentOpen || '<?= /** @noEscape */ $sectionIsOpen ?>';

                    // otvoriť príslušný <details>
                    const all = this.$refs.accordion.querySelectorAll('details');
                    all.forEach(d => {
                        if (d.id === this.currentOpen) {
                            d.setAttribute('open', 'open');
                        } else {
                            d.removeAttribute('open');
                        }
                    });

                    // plynulý scroll k sekcii
                    this.$nextTick(() => {
                        const target = document.getElementById(this.currentOpen);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                        }
                    });
                },
                sectionItemIsOpen() {
                    const id = this.$el.id || this.$el.dataset.id;
                    return this.currentOpen === id;
                }
            }
        }
        window.addEventListener('alpine:init', () => Alpine.data('initProductSections', initProductSections), { once: true });
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>

    <!-- Noscript fallback: zobraz súhrny -->
    <noscript>
        <style>details[data-name] summary { display: flex }</style>
    </noscript>
</div>
