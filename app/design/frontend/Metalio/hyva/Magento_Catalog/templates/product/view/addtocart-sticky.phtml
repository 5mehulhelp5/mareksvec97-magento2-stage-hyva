<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\ProductPage;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;

/** @var Escaper $escaper */
/** @var Product $block */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

/** @var ProductPage $productViewModel */
$productViewModel = $viewModels->require(ProductPage::class);

/** @var Product $product */
$product = $productViewModel->getProduct();
$productImg = $productViewModel->getImage($product, 'product_page_image_small');
$productType = $product->getTypeId();
$isMobileOnly = $block->getMobileOnly() !== null
    ? (bool) $block->getMobileOnly()
    : true;
$showAfterAddToCart = $block->getOnlyShowAfterAddToCart() !== null
    ? (bool) $block->getOnlyShowAfterAddToCart()
    : true;
$truncateTitle = $block->getTruncateTitle() !== null
    ? (bool) $block->getTruncateTitle()
    : true;

$classes = 'z-20 sticky -bottom-px inset-x-0 border-y bg-white text-slate-700';
if ($isMobileOnly) {
    $classes .= ' lg:hidden';
}
if ($showAfterAddToCart) {
    $classes .= ' opacity-0 data-[sticky=false]:opacity-100 data-[sticky=false]:translate-y-0 transition ease-out duration-300';
}
?>

<section
    id="stickyAddToCart"
    class="<?= $classes ?> data-[sticky=true]:shadow-2xl data-[sticky=true]:border-transparent"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Add %1 to Cart', $product->getName())) ?>"
>
    <div class="container py-6 grid grid-cols-[auto_minmax(0px,1fr)_auto] gap-2 items-center">
        <img
            src="<?= $escaper->escapeUrl($productImg->getImageUrl()) ?>"
            alt="<?= $escaper->escapeHtmlAttr($productImg->getLabel()) ?>"
            width="<?= $escaper->escapeHtmlAttr(round($productImg->getWidth() / 1.5)) ?>"
            height="<?= $escaper->escapeHtmlAttr(round($productImg->getHeight() / 1.5)) ?>"
            loading="lazy"
        />
        <div class="text-slate-800 text-lg overflow-hidden">
            <p class="md:text-xl xl:text-2xl title-font leading-tight <?= $truncateTitle ? 'truncate' : '' ?>">
                <strong class="font-semibold"><?= $escaper->escapeHtml($product->getName()) ?></strong>
            </p>
            <?php if ($productType !== 'grouped' && $productType !== 'bundle'): ?>
                <div class="relative
                    [&_.price-container]:flex
                    [&_.price-container]:items-baseline
                    [&_.price-container]:gap-2

                    [&_.old-price]:flex
                    [&_.old-price]:mr-2
                    [&_.old-price_.price-wrapper]:text-base
                    [&_.old-price_.price-wrapper]:line-through
                    [&_.old-price_.price-wrapper]:text-slate-500
                    [&_.old-price_.price-wrapper]:font-medium

                    [&_.final-price]:inline-flex
                    [&_.final-price]:items-baseline
                    [&_.final-price]:gap-2

                    [&_.final-price_.price-label]:inline
                    [&_.final-price_.price-label]:text-xs
                    [&_.final-price_.price-label]:font-medium
                    [&_.final-price_.price-label]:text-slate-500

                    [&_.final-price_.price-wrapper]:text-xl
                    [&_.final-price_.price-wrapper]:font-bold
                    [&_.final-price_.price-wrapper]:text-gray-900

                    [&_.price]:whitespace-nowrap
                ">
                    <?= $block->getChildHtml('price') ?>
                </div>
            <?php endif ?>
        </div>
        <?php if ($product->isSaleable()): ?>
            <button
                x-data="{ loading: false }"
                type="submit"
                form="product_addtocart_form"
                class="btn-action relative"
                data-addto="cart"
                :disabled="loading"
                :aria-busy="loading ? 'true' : 'false'"
                @click.prevent="
                    const form = document.getElementById('product_addtocart_form');
                    if (!form) { return; }

                   
                    if (typeof form.reportValidity === 'function' && !form.reportValidity()) {
                        loading = false;
                        return;
                    }

                    loading = true;

                    if (typeof form.requestSubmit === 'function') {
                        form.requestSubmit();
                    } else {
                        form.submit();
                    }
                "
            >
                <!-- kruhový loader -->
                <span
                    class="absolute inset-0 flex items-center justify-center"
                    x-show="loading"
                    x-cloak
                    aria-hidden="true"
                >
                    <span class="w-5 h-5 rounded-full border-2 border-current border-t-transparent animate-spin"></span>
                </span>

                <!-- pôvodný obsah (skryť počas loadingu) -->
                <span class="inline-flex items-center gap-2" :class="loading ? 'invisible' : ''">
                    <?= $heroicons->shoppingCartHtml('', 24, 24, ['aria-hidden' => 'true']); ?>
                    <span class="sr-only sm:not-sr-only">
                        <?= $block->getData('is_cart_configure')
                            ? $escaper->escapeHtml(__('Update item'))
                            : $escaper->escapeHtml(__('Add to Cart')) ?>
                    </span>
                </span>
            </button>

        <?php endif ?>
    </div>
    <script>
        (() => {
            const form = document.getElementById('product_addtocart_form');
            if (form) {
                form.classList.add('[&_:is(input,select,textarea)]:scroll-my-36');
            }

            const stickyAddToCart = document.getElementById('stickyAddToCart');
            stickyAddToCart.dataset.sticky = 'initial';
            new IntersectionObserver(([e]) =>
                e.target.dataset.sticky = e.intersectionRatio < 1,
                { threshold: 1 }
            ).observe(stickyAddToCart);

            <?php if ($showAfterAddToCart): ?>
                const addToCartBtn = document.getElementById('product-addtocart-button');
                if (!addToCartBtn) return;
                new IntersectionObserver(([e]) => {
                    const rect = e.target.getBoundingClientRect();
                    const hideStickyAtc = Math.round(rect.top + rect.height) > (rect.height / 2);
                    stickyAddToCart.classList.toggle('translate-y-full', hideStickyAtc);
                    stickyAddToCart.classList.toggle('opacity-0', hideStickyAtc);
                }, { threshold: [0, 1] }).observe(addToCartBtn);
            <?php endif ?>
        })();
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>
</section>
