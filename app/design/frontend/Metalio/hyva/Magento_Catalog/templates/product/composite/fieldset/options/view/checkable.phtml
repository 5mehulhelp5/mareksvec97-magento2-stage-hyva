<?php
/**
 * Hyvä Themes – Custom Options (Radio/Checkbox) ako „swatch pill“
 * - Tailwind-only (bg-primary / border-primary / ring-primary)
 * - input je skrytý (sr-only), štýluje sa label cez peer-* stavy
 * - cena má na hover/active/checked biely text a prebité vnorené .price spany
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\ProductPrice;
use Magento\Catalog\Block\Product\View\Options\Type\Select\Checkable;
use Magento\Catalog\Model\Product\Option;
use Magento\Catalog\Pricing\Price\CustomOptionPrice;
use Magento\Framework\Escaper;

/** @var Checkable $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$product = $block->getProduct();
/** @var ProductPrice $productPriceViewModel */
$productPriceViewModel = $viewModels->require(ProductPrice::class);

$option = $block->getOption();


if ($option): ?>
    <?php
    $configValue = $block->getPreconfiguredValue($option);
    $optionType  = $option->getType(); // radio | checkbox
    $arraySign   = $optionType === Option::OPTION_TYPE_CHECKBOX ? '[]' : '';
    $isRadio     = $optionType === Option::OPTION_TYPE_RADIO;
    $role        = $isRadio ? 'radiogroup' : 'group';
    ?>

    <!-- Wrapper ako swatch riadok -->
    <div
        id="options-<?= $escaper->escapeHtmlAttr($option->getId()) ?>-list"
        class="swatch-attribute-options flex flex-wrap items-center gap-2"
        role="<?= $role ?>"
        aria-label="<?= $escaper->escapeHtmlAttr($option->getTitle()) ?>"
    >
        <?php if ($isRadio && !$option->getIsRequire()): ?>
            <?php $noneId = 'options_' . $option->getId(); ?>
            <div class="relative">
                <input
                    type="radio"
                    id="<?= $escaper->escapeHtmlAttr($noneId) ?>"
                    class="peer sr-only product-custom-option"
                    name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]"
                    value=""
                    checked
                    x-on:change="updateCustomOptionValue(
                        $dispatch,'<?= $escaper->escapeHtmlAttr($option->getId()) ?>',$event.target
                    )"
                />
                <label
                    for="<?= $escaper->escapeHtmlAttr($noneId) ?>"
                    class="group swatch-option inline-flex items-center justify-center select-none
                           rounded-full px-4 h-10 border text-sm font-medium cursor-pointer
                           transition-colors duration-150
                           bg-white text-gray-700 border-slate-300 hover:bg-gray-50
                           peer-focus-visible:ring-2 peer-focus-visible:ring-primary peer-focus-visible:ring-offset-1 peer-focus-visible:ring-offset-white
                           peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary
                           /* pre istotu bieli text vnorených price spanov aj pri checked (None cenu nemá) */
                           peer-checked:[&_.price]:!text-white peer-checked:[&_.price-wrapper]:!text-white peer-checked:[&_.price-notice]:!text-white"
                    x-html="updateOptionPrice('<?= $escaper->escapeJs($option->getId()) ?>', $el)"
                >
                    <span><?= $escaper->escapeHtml(__('None')) ?></span>
                    <span class="ml-2 opacity-70"></span>
                </label>
            </div>
        <?php endif; ?>

        <?php foreach ($option->getValues() as $value): ?>
            <?php
            // checked stav podľa prekonfigurovanej hodnoty
            if ($arraySign) {
                $checked = is_array($configValue) && in_array($value->getOptionTypeId(), $configValue, false) ? 'checked' : '';
            } else {
                $checked = ($configValue == $value->getOptionTypeId()) ? 'checked' : '';
            }

            $valuePrice = $productPriceViewModel->getCustomOptionPrice($value, CustomOptionPrice::PRICE_CODE, $product);
            if ($productPriceViewModel->displayPriceInclAndExclTax()) {
                $valueBasePrice = $value->getPrice(true);
            }

            $optId   = $option->getId() . '_' . $value->getOptionTypeId();
            $inputId = 'options_' . $optId;

            // Už vyššie v kóde máš $valuePrice = $productPriceViewModel->getCustomOptionPrice(...);
            $priceHtml = trim($block->formatPrice($value));

            // Prisúď, či má zmysel cenu zobraziť:
            $hasPrice = $priceHtml !== '' && preg_match('/\d/', $priceHtml); // je tam aspoň číslica?

            // Fallback: ak by formatPrice() vrátilo niečo nečitateľné, použi numeriku
            if (!$hasPrice) {
                $hasPrice = ((float) $valuePrice) > 0;
            }
            ?>
            <div class="relative">
                <input
                    type="<?= $escaper->escapeHtmlAttr($optionType) ?>"
                    id="<?= $escaper->escapeHtmlAttr($inputId) ?>"
                    class="peer sr-only product-custom-option"
                    name="options[<?= $escaper->escapeHtmlAttr($option->getId()) ?>]<?= /* @noEscape */ $arraySign ?>"
                    value="<?= $escaper->escapeHtmlAttr($value->getOptionTypeId()) ?>"
                    <?= $escaper->escapeHtml($checked) ?>
                    x-ref="option-<?= $escaper->escapeHtmlAttr($optId) ?>"
                    <?php if ($option->getIsRequire()): ?>
                        required
                        data-required
                        oninvalid="this.setCustomValidity(this.dataset.validationMessage)"
                        oninput="this.setCustomValidity('')"
                        data-validation-message="<?= $escaper->escapeHtmlAttr(__("Please select one of the options.")) ?>"
                    <?php endif; ?>
                    data-price-amount="<?= $escaper->escapeHtmlAttr($valuePrice) ?>"
                    <?php if ($productPriceViewModel->displayPriceInclAndExclTax()): ?>
                        data-base-price-amount="<?= $escaper->escapeHtmlAttr($valueBasePrice) ?>"
                    <?php endif; ?>
                    data-price-type="<?= $escaper->escapeHtmlAttr($value->getPriceType()) ?>"
                    data-option-id="<?= $escaper->escapeHtmlAttr($optId) ?>"
                    x-on:change="updateCustomOptionValue(
                        $dispatch,'<?= $escaper->escapeHtmlAttr($optId) ?>',$event.target
                    )"
                />

                <label
                    for="<?= $escaper->escapeHtmlAttr($inputId) ?>"
                    class="group swatch-option m-0 inline-flex items-center justify-center select-none
                           rounded-full px-4 h-10 border text-sm font-medium cursor-pointer
                           transition-colors duration-150
                           bg-white text-gray-700 border-slate-300 hover:bg-gray-50
                           peer-focus-visible:ring-2 peer-focus-visible:ring-primary peer-focus-visible:ring-offset-1 peer-focus-visible:ring-offset-white
                           peer-checked:bg-primary peer-checked:text-white peer-checked:border-primary peer-checked:shadow-sm
                           /* na HOVER/ACTIVE/ CHECKED prebij farbu vnorených .price* na bielu */
                           group-hover:[&_.price]:!text-white group-hover:[&_.price-wrapper]:!text-white group-hover:[&_.price-notice]:!text-white
                           group-active:[&_.price]:!text-white group-active:[&_.price-wrapper]:!text-white group-active:[&_.price-notice]:!text-white
                           peer-checked:[&_.price]:!text-white peer-checked:[&_.price-wrapper]:!text-white peer-checked:[&_.price-notice]:!text-white
                           /* prebij aj veľkosť/weight vnorených price spanov */
                           [&_.price]:!text-[11px] [&_.price]:!leading-none [&_.price]:!font-semibold
                           [&_.price-wrapper]:!text-[11px] [&_.price-wrapper]:!leading-none [&_.price-wrapper]:!font-semibold
                           [&_.price-notice]:!text-[11px] [&_.price-notice]:!leading-none [&_.price-notice]:!font-semibold"
                    x-html="updateOptionPrice('<?= $escaper->escapeJs($optId) ?>', $el)"
                >
                    <!-- Fallback (prepísaný JS-om), nechávame kvôli a11y/SEO -->
                    <span><?= $escaper->escapeHtml($value->getTitle()) ?></span>

                    <!-- Fallback cena: malé písmo + prebitie vnorených -->
                    <?php if ($hasPrice): ?>
                        <span class="ml-2 opacity-80 text-[11px] leading-none font-semibold
                                    [&_*]:!text-[11px] [&_*]:!leading-none [&_*]:!font-semibold
                                    
                                    group-active:!text-white group-active:[&_*]:!text-white">
                            <?= /* @noEscape */ $priceHtml ?>
                        </span>
                    <?php endif; ?>
                </label>
            </div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>
