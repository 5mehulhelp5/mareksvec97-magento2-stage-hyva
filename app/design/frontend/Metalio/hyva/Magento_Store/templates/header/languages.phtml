<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Store;
use Hyva\Theme\ViewModel\StoreSwitcher;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Store\ViewModel\SwitcherUrlProvider;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$switcherUrlProvider = $viewModels->require(SwitcherUrlProvider::class);
$storeViewModel = $viewModels->require(Store::class);
$storeSwitcherViewModel = $viewModels->require(StoreSwitcher::class);

$currentStore = $storeSwitcherViewModel->getStore();
$stores = $storeSwitcherViewModel->getStores();

$normalizeFlagCode = static function (string $storeCode): string {
    $code = strtolower(trim($storeCode));
    $code = str_replace('-', '_', $code);
    $parts = array_values(array_filter(explode('_', $code)));
    if (!$parts) return 'en';

    $last = end($parts);
    if (preg_match('/^[a-z]{2}$/', (string)$last)) {
        return (string)$last;
    }
    $fallback = substr((string)$parts[0], 0, 2);
    return $fallback ?: 'en';
};

$flagUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/circle/' . $flagCode . '.png');
};

$currentFlagCode = $normalizeFlagCode((string) $currentStore->getCode());
$uniqueId = '_' . uniqid();
$dialogId = 'lang_drawer' . $uniqueId;
?>

<?php if (count($stores) > 1): ?>
    <div x-data="initLanguageSwitcherUnified<?= $escaper->escapeHtml($uniqueId) ?>()" class="relative inline-flex">
        <!-- CHIP BUTTON -->
        <button
            type="button"
            @click.prevent="toggle()"
            @keydown.window.escape="close()"
            class="inline-flex items-center md:h-[48px] min-w-[48px] min-h-[48px] h-full gap-2
                   bg-gray-100 px-3 rounded-full hover:bg-gray-200 transition-colors
                   relative text-slate-800"
            aria-haspopup="true"
            :aria-expanded="open ? 'true' : 'false'"
            aria-controls="<?= $escaper->escapeHtmlAttr($dialogId) ?>"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagUrl($currentFlagCode)) ?>"
                alt=""
                class="h-5 w-5 rounded-sm object-contain"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />

            <span class="hidden md:inline text-sm font-semibold whitespace-nowrap">
                <?= $escaper->escapeHtml($currentStore->getName()) ?>
            </span>

            <!-- DESKTOP šípka: default dole, po otvorení hore -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                 class="hidden md:inline h-4 w-4 text-slate-600 transition-transform duration-200"
                 :class="open ? 'rotate-180' : ''"
                 aria-hidden="true">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
        </button>

        <!-- DESKTOP DROPDOWN -->
        <nav
            x-cloak
            x-show="open && isDesktop"
            x-transition.origin.top.right
            @click.outside="close()"
            class="absolute right-0 top-full z-30 mt-2 w-max max-w-[90vw] min-w-[14rem] overflow-auto
                   rounded-2xl shadow-lg bg-white border border-slate-200 p-1"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Choose your language')) ?>"
        >
            <div class="py-1" role="menu" aria-orientation="vertical">
                <?php foreach ($stores as $lang): ?>
                    <?php
                    $isCurrent = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                    $langFlagCode = $normalizeFlagCode((string) $lang->getCode());
                    ?>
                    <?php if (!$isCurrent): ?>
                        <a
                            href="<?= $escaper->escapeUrl($switcherUrlProvider->getTargetStoreRedirectUrl($lang)) ?>"
                            class="flex items-center gap-2 rounded-xl px-3 py-2 text-sm text-slate-800 hover:bg-gray-100 transition-colors"
                            role="menuitem"
                            @click="close()"
                        >
                            <img
                                src="<?= $escaper->escapeUrl($flagUrl($langFlagCode)) ?>"
                                alt=""
                                class="h-5 w-5 rounded-sm object-contain shrink-0"
                                width="20"
                                height="20"
                                loading="lazy"
                                decoding="async"
                            />
                            <span class="font-semibold whitespace-nowrap">
                                <?= $escaper->escapeHtml($lang->getName()) ?>
                            </span>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </nav>

        <!-- MOBILE DRAWER (ako minicart) -->
        <dialog
            id="<?= $escaper->escapeHtmlAttr($dialogId) ?>"
            x-ref="dialog"
            x-cloak
            x-show="open && !isDesktop"
            x-htmldialog.noscroll="close()"
            @click="onBackdropClick($event)"
            @keydown.escape.window="close()"
            class="
                open:flex flex-col
                h-full max-h-full max-w-full
                mr-0 ml-auto
                w-[85vw]
                p-0
                shadow-2xl bg-white text-slate-800
                border-l border-slate-200
                backdrop:bg-black/25 backdrop:backdrop-blur-sm
            "
            aria-label="<?= $escaper->escapeHtmlAttr(__('Choose your language')) ?>"
            x-transition:enter="transition ease-in-out duration-500"
            x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in-out duration-300"
            x-transition:leave-start="translate-x-0"
            x-transition:leave-end="translate-x-full"
        >
            <!-- Sticky header (ako drawer) -->
            <div class="sticky top-0 z-10 bg-white border-b border-slate-200 px-4 py-4 flex items-center justify-between">
                <div class="text-base font-semibold text-slate-800">
                    <?= $escaper->escapeHtml(__('Language')) ?>
                </div>

                <!-- Close chip (rovnaký štýl ako inde) -->
                <button
                    type="button"
                    @click="close()"
                    class="inline-flex items-center justify-center min-w-[48px] min-h-[48px] h-[48px]
                           bg-gray-100 px-3 rounded-full hover:bg-gray-200 transition-colors
                           relative text-slate-800"
                    aria-label="<?= $escaper->escapeHtmlAttr(__('Close')) ?>"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                         class="h-5 w-5" aria-hidden="true">
                        <path fill-rule="evenodd"
                              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                              clip-rule="evenodd"/>
                    </svg>
                </button>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto overscroll-y-contain px-4 py-3">
                <div class="flex flex-col">
                    <?php foreach ($stores as $lang): ?>
                        <?php
                        $isCurrent = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                        $langFlagCode = $normalizeFlagCode((string) $lang->getCode());
                        ?>
                        <?php if (!$isCurrent): ?>
                            <a
                                href="<?= $escaper->escapeUrl($switcherUrlProvider->getTargetStoreRedirectUrl($lang)) ?>"
                                class="flex items-center gap-3 rounded-2xl px-4 py-3 text-[15px] font-semibold text-slate-800
                                       hover:bg-gray-100 transition-colors"
                                @click="close()"
                            >
                                <img
                                    src="<?= $escaper->escapeUrl($flagUrl($langFlagCode)) ?>"
                                    alt=""
                                    class="h-6 w-6 rounded-sm object-contain shrink-0"
                                    width="24"
                                    height="24"
                                    loading="lazy"
                                    decoding="async"
                                />
                                <span class="truncate">
                                    <?= $escaper->escapeHtml($lang->getName()) ?>
                                </span>
                            </a>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            </div>
        </dialog>
    </div>

    <script>
    'use strict';

    function initLanguageSwitcherUnified<?= $escaper->escapeHtml($uniqueId) ?>() {
        return {
            open: false,

            get isDesktop() {
                return window.matchMedia('(min-width: 768px)').matches;
            },

            init() {
                window.addEventListener('resize', () => {
                    if (this.open && this.isDesktop) this.open = false;
                });
            },

            toggle() {
                this.open = !this.open; // nič viac
            },

            close() {
                this.open = false; // nič viac
            },

            onBackdropClick(event) {
                if (event.target === this.$refs.dialog) {
                    this.close();
                }
            }
        }
    }

    window.addEventListener(
        'alpine:init',
        () => Alpine.data(
            'initLanguageSwitcherUnified<?= $escaper->escapeHtml($uniqueId) ?>',
            initLanguageSwitcherUnified<?= $escaper->escapeHtml($uniqueId) ?>
        ),
        { once: true }
    );
    </script>

    <?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>
