<?php
/** @var \Magento\Framework\View\Element\Template $block */
$esc = [$block, 'escapeHtml'];

$om  = \Magento\Framework\App\ObjectManager::getInstance();
/** @var \Magento\Framework\App\Config\ScopeConfigInterface $cfg */
$cfg = $om->get(\Magento\Framework\App\Config\ScopeConfigInterface::class);

// Heroicons ViewModels (Hyvä)
$iconsO = $block->getViewModel(\Hyva\Theme\ViewModel\HeroiconsOutline::class);
$iconsS = $block->getViewModel(\Hyva\Theme\ViewModel\HeroiconsSolid::class); // ak by si chcel plné verzie ikon

// umožníme zmeniť cestu zo shortcode (ak by si mal viac FAQ sád)
$configPath = (string)($block->getData('config_path') ?: 'metalio_cms/faq/items_json');

$raw = (string)$cfg->getValue($configPath, \Magento\Store\Model\ScopeInterface::SCOPE_STORE);

$items = [];
if (trim($raw) !== '') {
    try {
        $data = json_decode($raw, true, 512, JSON_THROW_ON_ERROR);
        foreach ((array)$data as $row) {
            $q = isset($row['q']) ? trim((string)$row['q']) : '';
            $a = isset($row['a']) ? trim((string)$row['a']) : '';
            if ($q === '' || $a === '') continue;
            $items[] = [
                'q' => $q,
                'a' => $a,
                'cat' => isset($row['cat']) && $row['cat'] !== '' ? (string)$row['cat'] : null,
            ];
        }
    } catch (\Throwable $e) {
        $items = [];
    }
}

$title = (string)($block->getData('title') ?: __('Často kladené otázky'));
$intro = (string)($block->getData('intro') ?: '');
?>

<section class="w-full">
  <div class="mx-auto w-full">

    <?php if ($intro !== ''): ?>
      <div class="mt-3 text-[15px] leading-relaxed text-[#2C2C2C]">
        <?= $block->stripTags($intro, null, true, ['a','br','strong','em']) ?>
      </div>
    <?php endif; ?>

    <?php if ($items): ?>
      <div class="mt-6 space-y-3">
        <?php foreach ($items as $it): ?>
          <details class="group rounded-2xl bg-white ring-1 ring-black/5 shadow-sm transition-colors">
            <summary class="flex items-center justify-between gap-4 cursor-pointer list-none px-5 py-4 font-semibold text-[#1C1C1C]
                            focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/40 rounded-2xl
                            transition-colors group-open:text-primary">
              <span class="flex items-center gap-2">
                <?= $esc($it['q']) ?>
                <?php if (!empty($it['cat'])): ?>
                  <span class="align-middle rounded-full bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary">
                    <?= $esc($it['cat']) ?>
                  </span>
                <?php endif; ?>
              </span>

              <!-- Ikona + / − cez Hyvä Heroicons -->
              <span class="shrink-0 inline-flex items-center justify-center text-[#2C2C2C]/40 group-hover:text-[#2C2C2C] group-open:text-primary transition-colors" aria-hidden="true">
                <?php
                  // Plus (zobraziť, keď je detail zatvorený)
                  echo $iconsO
                    ? $iconsO->plus(['class' => 'w-5 h-5 block group-open:hidden'])
                    // fallback SVG ak by ViewModel nebol dostupný
                    : '<svg class="w-5 h-5 block group-open:hidden" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';

                  // Minus (zobraziť, keď je detail otvorený)
                  echo $iconsO
                    ? $iconsO->minus(['class' => 'w-5 h-5 hidden group-open:block'])
                    : '<svg class="w-5 h-5 hidden group-open:block" viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>';
                ?>
              </span>
            </summary>

            <div class="px-5 pb-4 text-[15px] leading-relaxed text-[#2C2C2C]">
              <?= $esc($it['a']) ?>
            </div>
          </details>
        <?php endforeach; ?>
      </div>
    <?php else: ?>
      <p class="mt-4 text-sm text-[#2C2C2C]/70"><?= $esc(__('FAQ je prázdne.')) ?></p>
    <?php endif; ?>
  </div>
</section>
