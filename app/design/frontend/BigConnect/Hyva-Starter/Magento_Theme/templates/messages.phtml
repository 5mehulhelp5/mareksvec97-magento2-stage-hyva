<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\StoreConfig;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Messages;
use Hyva\Theme\ViewModel\HyvaCsp;

/** @var Messages $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

/** @var HeroiconsSolid $heroIcons */
$heroIcons = $viewModels->require(HeroiconsSolid::class);

/** @var StoreConfig $storeConfig */
$storeConfig = $viewModels->require(StoreConfig::class);

$defaultSuccessMessageTimeout = $storeConfig->getStoreConfig('hyva_theme_general/messages/success_message_timeout');
$displayMode = (string) $block->getDisplayMode() ?: 'default';
$showIcon = (bool) $block->getShowIcon();
$cartUrl = $block->getUrl('checkout/cart');
?>
<script>
    <?php if ($defaultSuccessMessageTimeout): ?>
    window.defaultSuccessMessageTimeout = <?= (int) $defaultSuccessMessageTimeout ?>;
    <?php endif; ?>

    function initMessages() {
        "use strict";
        return {
            messages: window.mageMessages || [],

            // Flag pre Add to Cart success (kvôli CTA)
            recentAddToCart: false,
            _cartFlagTimer: null,

            // Helpers
            isEmpty() {
                return !this.messages || this.messages.length === 0;
            },
            hasMessages() {
                return !this.isEmpty();
            },

            // ⬇️ FIX 1: splicujeme, nenechávame undefined
            removeMessage(messageIndex) {
                if (messageIndex > -1 && messageIndex < this.messages.length) {
                    this.messages.splice(messageIndex, 1);
                }
            },

            addMessages(messages, hideAfter) {
                messages.map((message) => {
                    this.messages = this.messages.concat(message);
                    let timeout = hideAfter;
                    if (timeout === undefined && message.type === 'success' && window.defaultSuccessMessageTimeout) {
                        timeout = window.defaultSuccessMessageTimeout;
                    }
                    if (timeout) {
                        this.setHideTimeOut(this.messages.length - 1, timeout);
                    }
                });
            },
            setHideTimeOut(messageIndex, hideAfter) {
                setTimeout((idx) => { this.removeMessage(idx); }, hideAfter, messageIndex);
            },

            // Ikony / štýly
            getIcon(message) {
                switch (message?.type) {
                    case 'success':
                        return <?= /** @noEscape */ json_encode($heroIcons->checkCircleHtml('', 32, 32)) ?>;
                    case 'error':
                    case 'warning':
                        return <?= /** @noEscape */ json_encode($heroIcons->exclamationHtml('', 32, 32)) ?>;
                    default:
                        return <?= /** @noEscape */ json_encode($heroIcons->informationCircleHtml('', 32, 32)) ?>;
                }
            },
            getMessageStyle(message) {
                switch (message?.type) {
                    case 'success':
                        return '[--message-lighter:theme(colors.green.100)] [--message:theme(colors.green.500)] [--message-darker:theme(colors.green.900)]';
                    case 'error':
                        return '[--message-lighter:theme(colors.red.100)] [--message:theme(colors.red.500)] [--message-darker:theme(colors.red.900)]';
                    case 'warning':
                        return '[--message-lighter:theme(colors.yellow.100)] [--message:theme(colors.yellow.500)] [--message-darker:theme(colors.yellow.900)]';
                    case 'notice':
                    case 'info':
                        return '[--message-lighter:theme(colors.blue.100)] [--message:theme(colors.blue.500)] [--message-darker:theme(colors.blue.900)]';
                    default:
                        return '[--message-lighter:theme(colors.slate.100)] [--message:theme(colors.slate.500)] [--message-darker:theme(colors.slate.900)]';
                }
            },
            getMessageUiId(message) {
                return 'message-' + (message?.type || 'info');
            },

            // Add to Cart detekcia (kvôli zobrazeniu CTA)
            markAddToCart() {
                this.recentAddToCart = true;
                clearTimeout(this._cartFlagTimer);
                this._cartFlagTimer = setTimeout(() => { this.recentAddToCart = false }, 8000);
            },
            isAddToCartMessage(msg) {
                if (!msg || msg.type !== 'success') return false;
                const t = (msg.text || '').toLowerCase();
                return /(košík|košíka|košíku|cart|warenkorb|koszyk|kosár)/.test(t);
            },
            showCartCta(msg) {
                return this.recentAddToCart || this.isAddToCartMessage(msg);
            },

            // Eventy
            eventListeners: {
                ['@messages-loaded.window'](event) {
                    this.addMessages(event.detail.messages, event.detail.hideAfter);
                },
                ['@private-content-loaded.window'](event) {
                    const data = event.detail.data;
                    if (data?.messages?.messages?.length) {
                        this.addMessages(data.messages.messages);
                    }
                },
                ['@clear-messages.window']() {
                    this.messages = [];
                },
                ['@open-ajax-cart.window']() {
                    this.markAddToCart();
                }
            }
        }
    }

    window.addEventListener('alpine:init', () => Alpine.data('initMessages', initMessages), { once: true });
</script>
<?php $hyvaCsp->registerInlineScript() ?>

<section
    id="messages"
    x-data="initMessages"
    x-bind="eventListeners"
    aria-live="assertive"
    role="alert"
>
    <template x-if="hasMessages()">
        <div class="messages container py-3">
            <template x-for="(message, index) in messages" :key="index">
                <div>
                    <!-- SUCCESS – s CTA len pri Add to Cart -->
                    <template x-if="message && message.type === 'success'">
                        <div
                            class="flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4 rounded-xl shadow-lg mb-6
                                   bg-green-50 text-green-900 py-4 px-4 sm:px-5"
                            :ui-id="getMessageUiId(message)"
                        >
                            <div class="flex items-start sm:items-center gap-2 sm:gap-3">
                                <span class="text-green-600 shrink-0" x-html="getIcon(message)"></span>
                                <span class="font-medium text-sm sm:text-base" x-html="message.text || '<?= $escaper->escapeHtml(__('Produkt bol vložený do košíka')) ?>'"></span>
                            </div>

                            <div class="flex items-center gap-2 sm:gap-3 sm:ml-auto">
                                <template x-if="showCartCta(message)">
                                    <a
                                        href="<?= $escaper->escapeUrl($cartUrl) ?>"
                                        class="w-full sm:w-auto inline-flex justify-center items-center gap-2 rounded-full
                                               px-5 py-3 sm:px-6 sm:py-3
                                               bg-green-500 hover:bg-green-600 text-white font-bold transition text-sm sm:text-base"
                                    >
                                        <?= $escaper->escapeHtml(__('Pokračovať do košíka')) ?>
                                        <?= $heroIcons->chevronRightHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
                                    </a>
                                </template>

                                <button
                                    type="button"
                                    class="self-start sm:self-auto text-green-700/70 hover:text-green-800 transition p-1"
                                    aria-label="<?= $escaper->escapeHtml(__('Close message')) ?>"
                                    @click.prevent="removeMessage(index)"
                                >
                                    <?= $heroIcons->xHtml('', 22, 22, ['aria-hidden' => 'true']); ?>
                                </button>
                            </div>
                        </div>
                    </template>

                    <!-- OSTATNÉ TYPY -->
                    <!-- ⬇️ FIX 2: renderuj len ak message existuje -->
                    <template x-if="message && message.type !== 'success'">
                        <div
                            class="message items-stretch gap-4 rounded-xl shadow-lg font-bold mb-6
                                <?= $displayMode === 'tag' || $displayMode === 'blank'
                                    ? 'bg-white text-slate-800'
                                    : 'bg-[var(--message-lighter)] text-[var(--message-darker)]' ?>
                                <?= $displayMode === 'tag' ? 'p-0' : 'py-6 px-8' ?>"
                            :ui-id="getMessageUiId(message)"
                            :class="getMessageStyle(message)"
                        >
                            <?php if ($displayMode === 'tag'): ?>
                                <div class="pl-4 rounded-l-xl bg-[var(--message)]">
                                    <?php if ($showIcon): ?>
                                        <div class="py-6 pr-4 text-white" x-html="getIcon(message)"></div>
                                    <?php endif ?>
                                </div>
                            <?php endif ?>

                            <div class="grow flex items-center <?= $displayMode === 'tag' ? 'gap-6 py-6 pr-8' : 'gap-6' ?>">
                                <?php if ($showIcon && $displayMode !== 'tag'): ?>
                                    <?php if ($displayMode === 'blank'): ?>
                                        <span x-html="getIcon(message)" class="text-[var(--message)]"></span>
                                    <?php else: ?>
                                        <span x-html="getIcon(message)"></span>
                                    <?php endif ?>
                                <?php endif ?>

                                <span x-html="message && message.text ? message.text : ''"></span>

                                <button
                                    type="button"
                                    class="ml-auto transition-colors <?= $displayMode === 'tag' || $displayMode === 'blank'
                                        ? 'text-slate-500 hover:text-slate-900'
                                        : 'text-[var(--message)] hover:text-[var(--message-darker)]' ?>"
                                    aria-label="<?= $escaper->escapeHtml(__('Close message')) ?>"
                                    @click.prevent="removeMessage(index)"
                                >
                                    <?= $heroIcons->xHtml('', 32, 32, ['aria-hidden' => 'true']); ?>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </template>
</section>
