<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Navigation;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Escaper;
use BigConnect\HyvaStarter\ViewModel\HeaderLinks;

use Magento\Framework\App\ObjectManager;
use Magento\Catalog\Api\CategoryRepositoryInterface;
use Magento\Store\Model\StoreManagerInterface;
use Magento\UrlRewrite\Model\ResourceModel\UrlRewriteCollectionFactory;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$heroicons = $viewModels->require(HeroiconsOutline::class);
$viewModelNavigation = $viewModels->require(Navigation::class, $block);
$headerLinks = $viewModels->require(HeaderLinks::class);
$headerLinkItems = $headerLinks->getItems();

$menuItems = $viewModelNavigation->getNavigation(4);
$block->setData('cache_tags', $viewModelNavigation->getIdentities());

// ikonky kategórií
$om = ObjectManager::getInstance();
/** @var CategoryRepositoryInterface $catRepo */
$catRepo = $om->get(CategoryRepositoryInterface::class);
/** @var StoreManagerInterface $storeManager */
$storeManager = $om->get(StoreManagerInterface::class);

$storeId   = (int) $storeManager->getStore()->getId();
$mediaBaseFull = rtrim($storeManager->getStore()->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA), '/');

$__toUrl = static function ($val) use ($mediaBaseFull): ?string {
    if (empty($val)) return null;

    if (is_array($val)) {
        if (isset($val[0]['url']) && $val[0]['url']) $val = (string) $val[0]['url'];
        elseif (isset($val['url']) && $val['url'])   $val = (string) $val['url'];
        elseif (isset($val[0]['name']) && $val[0]['name']) $val = (string) $val[0]['name'];
        elseif (isset($val['name']) && $val['name'])       $val = (string) $val['name'];
        else return null;
    }

    if (!is_string($val) || ($val = trim($val)) === '') return null;
    if (preg_match('#^https?://#i', $val)) return $val;

    if (stripos($val, $mediaBaseFull) === 0) {
        $val = substr($val, strlen($mediaBaseFull));
    }

    $val = ltrim($val, '/');
    $val = preg_replace('#^(media/)?(catalog/)?category/#i', '', $val);

    return $mediaBaseFull . '/catalog/category/' . ltrim($val, '/');
};

$__categoryIconUrl = function (int $categoryId) use ($catRepo, $storeId, $__toUrl): ?string {
    static $cache = [];
    if (isset($cache[$categoryId])) return $cache[$categoryId];

    try {
        $cat = $catRepo->get($categoryId, $storeId);

        $url = $__toUrl($cat->getData('thumbnail'));
        if ($url) return $cache[$categoryId] = $url;

        $url = $__toUrl($cat->getData('image'));
        return $cache[$categoryId] = $url ?: null;
    } catch (\Throwable $e) {
        return $cache[$categoryId] = null;
    }
};

$__resolveCategoryId = function (array $item) use ($storeManager, $om): int {
    foreach (['entity_id', 'category_id', 'id'] as $k) {
        if (isset($item[$k])) {
            $v = $item[$k];
            if (is_numeric($v)) return (int) $v;
            if (is_string($v) && preg_match('/\d+/', $v, $m)) return (int) $m[0];
        }
    }

    if (!empty($item['path']) && preg_match('/(\d+)(?!.*\d)/', (string) $item['path'], $m)) {
        return (int) $m[1];
    }

    if (!empty($item['url'])) {
        try {
            $base = $storeManager->getStore()->getBaseUrl();
            $req  = ltrim(str_replace($base, '', (string) $item['url']), '/');
            $req  = strtok($req, '?');

            /** @var UrlRewriteCollectionFactory $urlColFactory */
            $urlColFactory = $om->get(UrlRewriteCollectionFactory::class);

            $col = $urlColFactory->create()
                ->addFieldToFilter('request_path', $req)
                ->addFieldToFilter('store_id', (int) $storeManager->getStore()->getId());

            $rewrite = $col->getFirstItem();
            $target  = (string) $rewrite->getTargetPath();

            if ($target && preg_match('/catalog\/category\/view\/id\/(\d+)/', $target, $mm)) {
                return (int) $mm[1];
            }
        } catch (\Throwable $e) {}
    }

    return 0;
};

$dialogId = 'mobile-menu-drawer';

$renderIconHtml = static function (string $iconKey, string $class) use ($heroicons): string {
    $iconMap = [
        'sparkles' => ['sparklesHtml'],
        'factory' => ['buildingOffice2Html', 'buildingOfficeHtml'],
        'info' => ['informationCircleHtml'],
        'phone' => ['phoneHtml'],
        'mail' => ['envelopeHtml', 'mailHtml'],
        'map' => ['mapPinHtml', 'mapHtml'],
        'message' => ['chatBubbleLeftRightHtml', 'chatBubbleLeftEllipsisHtml'],
        'star' => ['starHtml'],
    ];

    $methods = $iconMap[$iconKey] ?? ['informationCircleHtml'];
    foreach ($methods as $method) {
        if (method_exists($heroicons, $method)) {
            return $heroicons->$method($class, 20, 20, ['aria-hidden' => 'true']);
        }
    }

    return $heroicons->informationCircleHtml($class, 20, 20, ['aria-hidden' => 'true']);
};
?>

<nav
    x-data="initMenuMobileDrawer()"
    @keydown.window.escape="closeMenu()"
    class="navigation lg:hidden"
    aria-label="<?= $escaper->escapeHtmlAttr(__('Site navigation')) ?>"
    role="navigation"
>
    <!-- Trigger -->
    <button
        x-ref="mobileMenuTrigger"
        @click="openMenu()"
        type="button"
        class="md:hidden p-2 rounded-lg bg-secondary-lighter border border-border hover:bg-secondary transition-colors focus:outline-none focus:ring-2 focus:ring-primary/40"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Menu')) ?>"
        aria-haspopup="dialog"
        :aria-expanded="open ? 'true' : 'false'"
    >
        <?= $heroicons->menuHtml('w-5 h-5 text-text/80', 20, 20, ['aria-hidden' => 'true']) ?>
    </button>

    <!-- Overlay -->
    <div
        x-cloak
        x-show="open"
        x-transition.opacity.duration.300ms
        @click="closeMenu()"
        class="fixed inset-0 bg-black/50 z-40"
        aria-hidden="true"
    ></div>

    <!-- DRAWER -->
    <dialog
        id="<?= $escaper->escapeHtmlAttr($dialogId) ?>"
        x-ref="dialog"
        x-cloak
        x-show="open"
        x-htmldialog.noscroll="closeMenu()"
        @click="onBackdropClick($event)"
        class="
            open:flex flex-col
            fixed top-0 left-0
            h-full max-h-full
            p-0 m-0
            bg-container shadow-2xl
            z-50
            w-[90vw] max-w-sm
            border-r border-border
        "
        aria-label="<?= $escaper->escapeHtmlAttr(__('Site navigation')) ?>"
        x-transition:enter="transition-transform duration-300 ease-in-out"
        x-transition:enter-start="-translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition-transform duration-300 ease-in-out"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="-translate-x-full"
    >
        <!-- Header (MAIN) -->
        <div
            x-show="mobilePanelActiveId === null"
            class="px-5 py-4 border-b border-border flex items-center justify-between"
        >
            <h2 class="font-bold text-base text-text">
                <?= $escaper->escapeHtml(__('Menu')) ?>
            </h2>

            <button
                type="button"
                @click="closeMenu()"
                class="w-9 h-9 flex items-center justify-center hover:bg-secondary-lighter rounded-lg transition-colors"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Close menu')) ?>"
            >
                <?= $heroicons->xHtml('w-5 h-5 text-muted', 20, 20, ['aria-hidden' => 'true']) ?>
            </button>
        </div>

        <!-- Body -->
        <div class="relative flex-1 overflow-hidden">
            <!-- MAIN LIST -->
            <div
                class="absolute inset-0 overflow-y-auto px-4 py-4 transition-transform duration-300 ease-in-out"
                :class="mobilePanelActiveId !== null ? '-translate-x-full' : 'translate-x-0'"
                aria-label="<?= $escaper->escapeHtmlAttr(__('Site navigation links')) ?>"
            >
                <div class="space-y-2">
                    <?php foreach ($menuItems as $index => $menuItem): ?>
                        <?php
                        $cid0 = $__resolveCategoryId($menuItem);
                        $iconUrl0 = $cid0 ? $__categoryIconUrl($cid0) : null;
                        $hasChildren = !empty($menuItem['childData']);
                        ?>
                        <div class="relative">
                            <a
                                href="<?= $escaper->escapeUrl($menuItem['url']) ?>"
                                title="<?= $escaper->escapeHtmlAttr($menuItem['name']) ?>"
                                @click="closeMenu()"
                                class="w-full flex items-center gap-3 p-3 bg-container rounded-lg border border-border hover:bg-secondary-lighter transition-all"
                            >
                                <?php if ($iconUrl0): ?>
                                    <img
                                        src="<?= $escaper->escapeUrl($iconUrl0) ?>"
                                        alt=""
                                        width="28" height="28"
                                        class="w-6 h-6 flex-shrink-0"
                                        loading="lazy" decoding="async"
                                    />
                                <?php else: ?>
                                    <span class="w-7 h-7 flex-shrink-0"></span>
                                <?php endif; ?>

                                <div class="text-left flex-1 min-w-0">
                                    <h3 class="font-semibold text-text text-[15px] leading-tight truncate">
                                        <?= $escaper->escapeHtml($menuItem['name']) ?>
                                    </h3>
                                </div>

                                <?php if ($hasChildren): ?>
                                    <button
                                        type="button"
                                        @click.prevent.stop="openSubcategory('<?= $escaper->escapeJs((string) $index) ?>')"
                                        class="w-8 h-8 flex items-center justify-center rounded-lg bg-secondary-lighter hover:bg-secondary transition-colors flex-shrink-0"
                                        aria-label="<?= $escaper->escapeHtmlAttr(__('Open %1 subcategories', $menuItem['name'])) ?>"
                                    >
                                        <?= $heroicons->chevronRightHtml('w-4 h-4 text-muted', 16, 16, ['aria-hidden' => 'true']) ?>
                                    </button>
                                <?php endif; ?>
                            </a>
                        </div>
                    <?php endforeach; ?>
                    <?php if ($headerLinkItems): ?>
                        <div class="pt-4 border-t border-border space-y-2">
                            <?php foreach ($headerLinkItems as $item): ?>
                                <?php
                                $variant = $item['variant'] === 'cta' ? 'cta' : 'default';
                                $linkClass = $variant === 'cta'
                                    ? 'flex items-center gap-2 px-4 py-2 rounded-lg transition-all group relative overflow-hidden bg-inspiration hover:bg-inspiration-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70'
                                    : 'flex items-center gap-2 text-white/80 hover:text-white transition-colors';
                                $iconClass = $variant === 'cta'
                                    ? 'w-4 h-4 lg:w-5 lg:h-5 text-white'
                                    : 'w-4 h-4 lg:w-5 lg:h-5 text-primary';
                                $labelClass = $variant === 'cta'
                                    ? 'font-semibold text-sm lg:text-base text-white'
                                    : 'font-medium text-sm lg:text-base';
                                ?>
                                <a
                                    href="<?= $escaper->escapeUrl($item['url']) ?>"
                                    aria-label="<?= $escaper->escapeHtmlAttr($item['label']) ?>"
                                    class="<?= $escaper->escapeHtmlAttr($linkClass) ?>"
                                    <?php if ($item['target_blank']): ?>
                                        target="_blank" rel="noopener noreferrer"
                                    <?php endif; ?>
                                >
                                    <?= /* @noEscape */ $renderIconHtml($item['icon'], $iconClass) ?>
                                    <span class="<?= $escaper->escapeHtmlAttr($labelClass) ?>">
                                        <?= $escaper->escapeHtml($item['label']) ?>
                                    </span>
                                    <?php if ($variant === 'cta'): ?>
                                        <span class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity" aria-hidden="true"></span>
                                    <?php endif; ?>
                                </a>
                            <?php endforeach; ?>
                        </div>
                    <?php endif; ?>
                </div>
            </div>

            <!-- SUB PANELS -->
            <?php foreach ($menuItems as $index => $menuItem): ?>
                <?php if (empty($menuItem['childData'])) continue; ?>

                <div
                    x-cloak
                    class="absolute inset-0 bg-container flex flex-col transition-transform duration-300 ease-in-out"
                    :class="mobilePanelActiveId === '<?= $escaper->escapeJs((string) $index) ?>' ? 'translate-x-0' : 'translate-x-full'"
                >
                    <!-- Sub header -->
                    <div class="px-5 py-4 border-b border-border flex-shrink-0">
                        <div class="flex items-center gap-3">
                            <button
                                type="button"
                                @click="backToMainCategories()"
                                class="w-9 h-9 flex items-center justify-center hover:bg-secondary-lighter rounded-lg transition-colors flex-shrink-0"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Back to main categories')) ?>"
                            >
                                <?= $heroicons->chevronLeftHtml('w-5 h-5 text-muted', 20, 20, ['aria-hidden' => 'true']) ?>
                            </button>

                            <h2 class="font-bold text-base text-text truncate">
                                <?= $escaper->escapeHtml($menuItem['name']) ?>
                            </h2>

                            <button
                                type="button"
                                @click="closeMenu()"
                                class="ml-auto w-9 h-9 flex items-center justify-center hover:bg-secondary-lighter rounded-lg transition-colors"
                                aria-label="<?= $escaper->escapeHtmlAttr(__('Close menu')) ?>"
                            >
                                <?= $heroicons->xHtml('w-5 h-5 text-muted', 20, 20, ['aria-hidden' => 'true']) ?>
                            </button>
                        </div>
                    </div>

                    <!-- Subcategories list -->
                    <div class="flex-1 overflow-y-auto px-4 py-4">
                        <div class="space-y-2">
                            <!-- Zobraziť všetko -->
                            <a
                                href="<?= $escaper->escapeUrl($menuItem['url']) ?>"
                                @click="closeMenu()"
                                class="w-full flex items-center gap-3 p-3 rounded-lg border border-border bg-secondary-lighter hover:bg-secondary transition-all"
                            >
                                <div class="text-left flex-1">
                                    <h3 class="font-semibold text-text text-[15px] leading-tight">
                                        <?= $escaper->escapeHtml(__('Zobraziť všetko')) ?>
                                    </h3>
                                </div>
                            </a>

                            <?php foreach ($menuItem['childData'] as $subMenuItem): ?>
                                <?php
                                $cid = $__resolveCategoryId($subMenuItem);
                                $iconUrl = $cid ? $__categoryIconUrl($cid) : null;
                                ?>
                                <a
                                    href="<?= $escaper->escapeUrl($subMenuItem['url']) ?>"
                                    @click="closeMenu()"
                                    title="<?= $escaper->escapeHtmlAttr($subMenuItem['name']) ?>"
                                    class="w-full flex items-center gap-3 p-3 bg-container rounded-lg border border-border hover:bg-secondary-lighter transition-all"
                                >
                                    <?php if ($iconUrl): ?>
                                        <img
                                            src="<?= $escaper->escapeUrl($iconUrl) ?>"
                                            alt=""
                                            width="28" height="28"
                                            class="w-7 h-7 rounded-full object-cover flex-shrink-0"
                                            loading="lazy" decoding="async"
                                        />
                                    <?php else: ?>
                                        <span class="w-7 h-7 flex-shrink-0"></span>
                                    <?php endif; ?>

                                    <div class="text-left flex-1 min-w-0">
                                        <h3 class="font-semibold text-text text-[15px] leading-tight truncate">
                                            <?= $escaper->escapeHtml($subMenuItem['name']) ?>
                                        </h3>
                                    </div>
                                </a>
                            <?php endforeach; ?>
                        </div>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
    </dialog>
</nav>

<script>
'use strict';

const initMenuMobileDrawer = () => {
    return {
        open: false,
        mobilePanelActiveId: null,
        closeTimer: null,

        openMenu() {
            this.open = true;
            this.mobilePanelActiveId = null;

            this.$nextTick(() => {
                if (typeof hyva !== 'undefined' && hyva.trapFocus) {
                    hyva.trapFocus(this.$refs.dialog);
                }
            });
        },

        closeMenu() {
            this.open = false;
            this.mobilePanelActiveId = null;

            this.$nextTick(() => {
                this.$refs.mobileMenuTrigger?.focus?.();
                if (typeof hyva !== 'undefined' && hyva.releaseFocus) {
                    hyva.releaseFocus();
                }
            });

            document.documentElement.style.overflow = '';
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        },

        onBackdropClick(e) {
            if (e.target === this.$refs.dialog) {
                this.closeMenu();
            }
        },

        openSubcategory(index) {
            this.mobilePanelActiveId = index;

            this.$nextTick(() => {
                const active = this.$refs.dialog?.querySelector('.translate-x-0');
                const list = active?.querySelector('[data-subpanel-scroll]');
                if (list) list.scrollTop = 0;
            });
        },

        backToMainCategories() {
            this.mobilePanelActiveId = null;
        },
    }
}

window.addEventListener('alpine:init', () => Alpine.data('initMenuMobileDrawer', initMenuMobileDrawer), {once: true})
</script>

<?php $hyvaCsp->registerInlineScript() ?>
