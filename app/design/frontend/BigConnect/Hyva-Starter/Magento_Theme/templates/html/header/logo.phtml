<?php
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\Logo\LogoSizeResolver;
use Hyva\Theme\ViewModel\Logo\LogoPathResolver;
use Hyva\Theme\ViewModel\StoreConfig;
use Magento\Framework\Escaper;
use Magento\Theme\Block\Html\Header\Logo;

use Magento\Framework\App\ObjectManager;
use Magento\Framework\App\Config\ScopeConfigInterface;
use Magento\Store\Model\ScopeInterface;

/** @var Logo $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** Pôvodné načítanie loga (tvoj existujúci kód) ... */
$storeConfig = $viewModels->require(StoreConfig::class);
$storeName   = $storeConfig->getStoreConfig('general/store_information/name') ?: $block->getThemeName() ?: __('Store logo');

$logoSizeResolver = $viewModels->require(LogoSizeResolver::class);
$logoWidth  = $logoSizeResolver && $logoSizeResolver->getWidth()  ? $logoSizeResolver->getWidth()  : ($block->getLogoWidth()  ?: 200);
$logoHeight = $logoSizeResolver && $logoSizeResolver->getHeight() ? $logoSizeResolver->getHeight() : ($block->getLogoHeight() ?: 150);

$logoPathResolver = $block->getData('logoPathResolver');
$logoSrc = $logoPathResolver && method_exists($logoPathResolver, 'getLogoSrc')
    ? $logoPathResolver->getLogoSrc($block->getData('logo_file'))
    : $block->getLogoSrc();

/** Načítanie configu pre badge SVG */
$om          = ObjectManager::getInstance();
$scopeConfig = $om->get(ScopeConfigInterface::class);

$badgeEnabled = (bool) $scopeConfig->isSetFlag('metalio/header/enabled', ScopeInterface::SCOPE_STORE);
$badgeSvgRaw  = (string) ($scopeConfig->getValue('metalio/header/badge_svg', ScopeInterface::SCOPE_STORE) ?? '');

/** Normalizácia SVG (ľahká) */
$badgeSvg = '';
if ($badgeEnabled && $badgeSvgRaw) {
    // odstráň XML deklaráciu, ak tam je
    $badgeSvg = preg_replace('/<\?xml[^>]*\?>/i', '', $badgeSvgRaw);

    // ak SVG nemá class, doplň výšku cez Tailwind triedy
    if (stripos($badgeSvg, '<svg') !== false && stripos($badgeSvg, ' class=') === false) {
        $badgeSvg = preg_replace('/<svg\b(?![^>]*\bclass=)/i', '<svg class="h-6 md:h-7 lg:h-8 w-auto"', $badgeSvg, 1);
    }
}
// Figma Make: h-7 md:h-10
$figmaDesktopHeightPx = 40;

// Pre CLS: prepočítame width podľa pomeru z resolvera (ak je k dispozícii)
$ratio = ($logoWidth > 0 && $logoHeight > 0) ? ($logoWidth / $logoHeight) : 5; // fallback ratio
$attrHeight = $figmaDesktopHeightPx;
$attrWidth  = (int) round($attrHeight * $ratio);
?>

<div class="flex items-center gap-3">
  <a
      class="inline-flex items-center flex-shrink-0"
      href="<?= $escaper->escapeUrl($block->getUrl()) ?>"
      title="<?= $escaper->escapeHtmlAttr(__('Go to Home page')) ?>"
  >
      <?php if ($logoSrc): ?>
          <img
              src="<?= $escaper->escapeUrl($logoSrc) ?>"
              alt="<?= $escaper->escapeHtmlAttr($block->getLogoAlt() ?: $storeName) ?>"
              width="<?= $escaper->escapeHtmlAttr($attrWidth) ?>"
              height="<?= $escaper->escapeHtmlAttr($attrHeight) ?>"
              class="h-7 md:h-10 w-auto"
              loading="eager"
              fetchpriority="high"
              decoding="async"
          >
      <?php else: ?>
          <span class="text-xl font-medium font-title">
              <?= $escaper->escapeHtml($storeName) ?>
          </span>
      <?php endif; ?>
  </a>
</div>
