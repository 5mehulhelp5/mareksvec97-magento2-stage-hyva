<?php
/**
 * desktop.phtml (CELÝ SÚBOR – bez inline hexov, farby cez tokeny, gradient cez bg-inspiration)
 */

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Hyva\Theme\ViewModel\Navigation;
use Magento\Framework\View\Element\Template;
use Magento\Framework\Escaper;
use Magento\Framework\App\ObjectManager;
use Magento\Catalog\Api\CategoryRepositoryInterface;
use Magento\Store\Model\StoreManagerInterface;
use Magento\UrlRewrite\Model\ResourceModel\UrlRewriteCollectionFactory;
use BigConnect\HyvaStarter\ViewModel\HeaderLinks;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

$viewModelNavigation = $viewModels->require(Navigation::class, $block);
$heroiconsSolid      = $viewModels->require(HeroiconsSolid::class);

$headerLinks     = $viewModels->require(HeaderLinks::class);
$headerLinkItems = $headerLinks->getItems();

$uniqueId = '_' . uniqid();

$menuItems = $viewModelNavigation->getNavigation(4);
$block->setData('cache_tags', $viewModelNavigation->getIdentities());

$om = ObjectManager::getInstance();
/** @var CategoryRepositoryInterface $catRepo */
$catRepo = $om->get(CategoryRepositoryInterface::class);
/** @var StoreManagerInterface $storeManager */
$storeManager = $om->get(StoreManagerInterface::class);

$storeId        = (int) $storeManager->getStore()->getId();
$mediaBaseFull  = rtrim($storeManager->getStore()->getBaseUrl(\Magento\Framework\UrlInterface::URL_TYPE_MEDIA), '/');

$__toUrl = static function ($val) use ($mediaBaseFull): ?string {
    if (empty($val)) return null;

    if (is_array($val)) {
        if (isset($val[0]['url']) && $val[0]['url']) $val = (string) $val[0]['url'];
        elseif (isset($val['url']) && $val['url'])   $val = (string) $val['url'];
        elseif (isset($val[0]['name']) && $val[0]['name']) $val = (string) $val[0]['name'];
        elseif (isset($val['name']) && $val['name'])       $val = (string) $val['name'];
        else return null;
    }

    if (!is_string($val) || ($val = trim($val)) === '') return null;

    if (preg_match('#^https?://#i', $val)) return $val;

    if (stripos($val, $mediaBaseFull) === 0) {
        $val = substr($val, strlen($mediaBaseFull));
    }

    $val = ltrim($val, '/');
    $val = preg_replace('#^(media/)?(catalog/)?category/#i', '', $val);

    return $mediaBaseFull . '/catalog/category/' . ltrim($val, '/');
};

$__categoryIconUrl = function (int $categoryId) use ($catRepo, $storeId, $__toUrl): ?string {
    static $cache = [];
    if (isset($cache[$categoryId])) return $cache[$categoryId];

    try {
        $cat = $catRepo->get($categoryId, $storeId);

        $url = $__toUrl($cat->getData('thumbnail'));
        if ($url) return $cache[$categoryId] = $url;

        $url = $__toUrl($cat->getData('image'));
        return $cache[$categoryId] = $url ?: null;
    } catch (\Throwable $e) {
        return $cache[$categoryId] = null;
    }
};

$__resolveCategoryId = function (array $item) use ($storeManager, $om): int {
    foreach (['entity_id', 'category_id', 'id'] as $k) {
        if (isset($item[$k])) {
            $v = $item[$k];
            if (is_numeric($v)) return (int) $v;
            if (is_string($v) && preg_match('/\d+/', $v, $m)) return (int) $m[0];
        }
    }

    if (!empty($item['path']) && preg_match('/(\d+)(?!.*\d)/', (string) $item['path'], $m)) {
        return (int) $m[1];
    }

    if (!empty($item['url'])) {
        try {
            $base = $storeManager->getStore()->getBaseUrl();
            $req  = ltrim(str_replace($base, '', (string) $item['url']), '/');
            $req  = strtok($req, '?');

            /** @var UrlRewriteCollectionFactory $urlColFactory */
            $urlColFactory = $om->get(UrlRewriteCollectionFactory::class);

            $col = $urlColFactory->create()
                ->addFieldToFilter('request_path', $req)
                ->addFieldToFilter('store_id', (int) $storeManager->getStore()->getId());

            $rewrite = $col->getFirstItem();
            $target  = (string) $rewrite->getTargetPath();

            if ($target && preg_match('/catalog\/category\/view\/id\/(\d+)/', $target, $mm)) {
                return (int) $mm[1];
            }
        } catch (\Throwable $e) {
            // ignore
        }
    }

    return 0;
};

$__isInspiration = static function (array $menuItem): bool {
    $name = mb_strtolower((string) ($menuItem['name'] ?? ''));
    $url  = (string) ($menuItem['url'] ?? '');
    return $name === 'inšpirácie'
        || str_contains($url, '/galeria')
        || str_contains($url, '/gallery');
};
?>

<div
    x-data="initMenuDesktop<?= $escaper->escapeHtml($uniqueId) ?>()"
    class="hidden md:block"
>
    <div x-ref="nav-desktop" @load.window="setActiveMenu($root)">
        <div class="mx-auto">
            <nav class="py-3" aria-label="<?= $escaper->escapeHtmlAttr(__('Main menu')) ?>">
                <ul class="flex items-center gap-6 lg:gap-8">
                    <?php foreach ($menuItems as $index => $menuItem): ?>
                        <?php
                        $cid0          = $__resolveCategoryId($menuItem);
                        $iconUrl0      = $cid0 ? $__categoryIconUrl($cid0) : null;
                        $hasChildren   = !empty($menuItem['childData']);
                        $isInspiration = $__isInspiration($menuItem);
                        ?>

                        <li
                            class="relative group"
                            <?php if ($hasChildren): ?>
                                @mouseenter="hoverPanelActiveId = '<?= (string) $index ?>'"
                                @mouseleave="hoverPanelActiveId = 0"
                                @keyup.escape="hoverPanelActiveId = 0"
                            <?php endif; ?>
                        >
                            <!-- HIT AREA -->
                            <div class="flex items-center gap-2 py-2">
                                <a
                                    href="<?= $escaper->escapeUrl($menuItem['url']) ?>"
                                    title="<?= $escaper->escapeHtmlAttr($menuItem['name']) ?>"
                                    @focus="hoverPanelActiveId = 0"
                                    class="<?php if ($isInspiration): ?>
                                        group inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-all relative overflow-hidden
                                        text-white font-semibold bg-inspiration hover:bg-inspiration-hover
                                        whitespace-nowrap
                                    <?php else: ?>
                                        group inline-flex items-center gap-2 text-gray-700 hover:text-black transition-colors
                                        whitespace-nowrap
                                    <?php endif; ?>"
                                >
                                    <?php if ($iconUrl0): ?>
                                        <img
                                            src="<?= $escaper->escapeUrl($iconUrl0) ?>"
                                            alt=""
                                            width="20" height="20"
                                            class="w-4 h-4 lg:w-5 lg:h-5 object-contain rounded-sm shrink-0"
                                            loading="lazy"
                                            decoding="async"
                                        />
                                    <?php endif; ?>

                                    <span class="<?php if ($isInspiration): ?>
                                        text-white text-sm lg:text-base leading-none whitespace-nowrap
                                    <?php else: ?>
                                        font-medium text-sm lg:text-base leading-none whitespace-nowrap
                                    <?php endif; ?>">
                                        <?= $escaper->escapeHtml($menuItem['name']) ?>
                                    </span>

                                    <?php if ($isInspiration): ?>
                                        <span class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" aria-hidden="true"></span>
                                    <?php endif; ?>
                                </a>

                                <?php if ($hasChildren): ?>
                                    <button
                                        type="button"
                                        data-sr-button-id="<?= $escaper->escapeHtmlAttr($index) ?>"
                                        :aria-expanded="hoverPanelActiveId === '<?= (string) $index ?>' ? 'true' : 'false'"
                                        @click="openMenuOnClick('<?= (string) $index ?>')"
                                        class="inline-flex items-center justify-center h-full leading-none text-gray-700 hover:text-black transition-colors"
                                    >
                                        <span
                                            class="inline-flex transition-transform translate-y-[0.5px]"
                                            :class="hoverPanelActiveId === '<?= (string) $index ?>' ? 'rotate-180' : ''"
                                        >
                                            <?= $heroiconsSolid->chevronDownHtml("", 16, 16, ['aria-hidden' => 'true']) ?>
                                        </span>
                                        <span class="sr-only">
                                            <?= $escaper->escapeHtml(__('Show submenu for %1 category', $menuItem['name'])) ?>
                                        </span>
                                    </button>
                                <?php endif; ?>
                            </div>

                            <?php if ($hasChildren): ?>
                                <!-- Dropdown -->
                                <div
                                    x-cloak
                                    class="absolute left-0 top-full z-50"
                                    :class="{
                                        'hidden' : hoverPanelActiveId !== '<?= (string) $index ?>',
                                        'block'  : hoverPanelActiveId === '<?= (string) $index ?>'
                                    }"
                                    @mouseenter="hoverPanelActiveId = '<?= (string) $index ?>'"
                                    @mouseleave="hoverPanelActiveId = 0"
                                >
                                    <!-- bridge -->
                                    <div class="h-2"></div>

                                    <div class="w-[480px] bg-white rounded-lg shadow-xl border border-border p-4">
                                        <div class="grid grid-cols-2 gap-2">
                                            <?php foreach ($menuItem['childData'] as $subMenuItem): ?>
                                                <?php
                                                $cid     = $__resolveCategoryId($subMenuItem);
                                                $iconUrl = $cid ? $__categoryIconUrl($cid) : null;
                                                ?>
                                                <a
                                                    href="<?= $escaper->escapeUrl($subMenuItem['url']) ?>"
                                                    title="<?= $escaper->escapeHtmlAttr($subMenuItem['name']) ?>"
                                                    class="flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-lg transition-colors"
                                                    role="menuitem"
                                                    @keyup.escape="$nextTick(() => document.querySelector('[data-sr-button-id=<?= $escaper->escapeJs($index) ?>]').focus())"
                                                >
                                                    <div class="w-12 h-12 bg-gray-100 rounded-md flex items-center justify-center p-1.5 flex-shrink-0 overflow-hidden">
                                                        <?php if ($iconUrl): ?>
                                                            <img
                                                                src="<?= $escaper->escapeUrl($iconUrl) ?>"
                                                                alt=""
                                                                class="w-full h-full object-contain"
                                                                width="48" height="48"
                                                                loading="lazy"
                                                                decoding="async"
                                                            />
                                                        <?php endif; ?>
                                                    </div>
                                                    <span class="font-medium text-gray-900 text-sm">
                                                        <?= $escaper->escapeHtml($subMenuItem['name']) ?>
                                                    </span>
                                                </a>
                                            <?php endforeach; ?>
                                        </div>

                                        <div class="border-t border-border mt-3 pt-3">
                                            <a
                                                href="<?= $escaper->escapeUrl($menuItem['url']) ?>"
                                                class="flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium hover:bg-primary/5 rounded-lg transition-colors text-primary"
                                            >
                                                <span>
                                                    <?= $escaper->escapeHtml(__('Zobraziť všetky %1', $menuItem['name'])) ?>
                                                </span>
                                                <span class="inline-flex -rotate-90">
                                                    <?= $heroiconsSolid->chevronDownHtml("", 16, 16, ['aria-hidden' => 'true']) ?>
                                                </span>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            <?php endif; ?>

                        </li>
                    <?php endforeach; ?>

                    <?php foreach ($headerLinkItems as $item): ?>
                        <?php
                        $variant = (($item['variant'] ?? '') === 'cta') ? 'cta' : 'link';

                        // Fix: drž všetko v jednom riadku
                        if ($variant === 'cta') {
                            $linkClass  = 'group inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-all relative overflow-hidden bg-inspiration hover:bg-inspiration-hover focus:outline-none focus-visible:ring-2 focus-visible:ring-white/70 whitespace-nowrap';
                            $labelClass = 'font-semibold text-sm lg:text-base text-white whitespace-nowrap leading-none relative z-10';
                            $iconClass  = 'w-4 h-4 lg:w-5 lg:h-5 text-white shrink-0 relative z-10';
                            $blinkClass = !empty($item['icon_blink']) ? ' animate-pulse' : '';
                        } else {
                            $linkClass  = 'group inline-flex items-center gap-2 px-2 py-1 rounded-md transition-colors text-gray-700 hover:text-black focus:outline-none focus-visible:ring-2 focus-visible:ring-black/20 whitespace-nowrap';
                            $labelClass = 'font-medium text-sm lg:text-base whitespace-nowrap leading-none';
                            $iconClass  = 'w-4 h-4 lg:w-5 lg:h-5 text-primary shrink-0';
                            $blinkClass = !empty($item['icon_blink']) ? ' group-hover:animate-pulse' : '';
                        }

                        $iconAlt = trim((string)($item['icon_alt'] ?? '')) ?: (string)($item['label'] ?? '');
                        ?>
                        <li class="shrink-0">
                            <a
                                href="<?= $escaper->escapeUrl((string) $item['url']) ?>"
                                aria-label="<?= $escaper->escapeHtmlAttr((string) $item['label']) ?>"
                                class="<?= $escaper->escapeHtmlAttr($linkClass) ?>"
                                <?php if (!empty($item['target_blank'])): ?>
                                    target="_blank" rel="noopener noreferrer"
                                <?php endif; ?>
                            >
                                <?php if (!empty($item['icon_svg_url'])): ?>
                                    <img
                                        src="<?= $escaper->escapeUrl((string) $item['icon_svg_url']) ?>"
                                        alt="<?= $escaper->escapeHtmlAttr($iconAlt) ?>"
                                        class="<?= $escaper->escapeHtmlAttr(trim($iconClass . $blinkClass)) ?>"
                                        loading="lazy"
                                        decoding="async"
                                    />
                                <?php endif; ?>

                                <span class="<?= $escaper->escapeHtmlAttr($labelClass) ?>">
                                    <?= $escaper->escapeHtml((string) $item['label']) ?>
                                </span>

                                <?php if ($variant === 'cta'): ?>
                                    <span
                                        class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"
                                        aria-hidden="true"
                                    ></span>
                                <?php endif; ?>
                            </a>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </nav>
        </div>
    </div>
</div>

<script>
'use strict';
const initMenuDesktop<?= $escaper->escapeHtml($uniqueId) ?> = () => {
    return {
        hoverPanelActiveId: 0,
        setActiveMenu(menuNode) {
            Array.from(menuNode.querySelectorAll('a'))
                .filter(link => link.href === window.location.href.split('?')[0])
                .map(link => {
                    link.setAttribute('aria-current', 'page');
                    link.classList.add('text-black');
                    link.closest('li')?.setAttribute('data-active', 'true');
                });
        },
        openMenuOnClick(menuNode) {
            this.hoverPanelActiveId = (menuNode === this.hoverPanelActiveId) ? 0 : menuNode;
        }
    }
}
</script>
