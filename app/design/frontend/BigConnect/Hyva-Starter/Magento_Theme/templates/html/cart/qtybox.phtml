<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HeroiconsSolid;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var ViewModelRegistry $viewModels */

$heroicons = $viewModels->require(HeroiconsOutline::class);
$heroiconsSolid = $viewModels->require(HeroiconsSolid::class);

$miniCartOptionQtyStyle = (string) $block->getMiniCartOptionQtyStyle() ?: 'default';
$miniCartOptionQtySaveAuto = $miniCartOptionQtyStyle === "incrementor" || $miniCartOptionQtyStyle === "select";

// React-like classes
$wrap    = 'flex items-center border border-gray-200 rounded-lg overflow-hidden bg-white';
$btnL    = 'p-2 hover:bg-gray-100 rounded-l-lg transition-colors';
$btnR    = 'p-2 hover:bg-gray-100 rounded-r-lg transition-colors';

// "span look", but real input
$inputClass = 'px-3 py-1 text-sm font-medium text-gray-900 min-w-[40px] w-[56px] text-center bg-transparent border-0 focus:outline-none focus:ring-0';

$autoSaveDebounceAttr = $miniCartOptionQtySaveAuto ? '@click.debounce.800ms="updateQty"' : '';
$autoSaveChangeAttr   = $miniCartOptionQtySaveAuto ? '@change.debounce.800ms="updateQty"' : '';
?>

<?php if ($miniCartOptionQtyStyle !== "text"): ?>
  <form
    action="<?= $escaper->escapeUrl($block->getUrl('checkout/sidebar/updateItemQty')) ?>"
    x-data="initCartDrawerQtyBox"
    @submit.prevent="updateItemQty"
    method="post"
    class="form form-cart inline-flex items-center gap-2"
  >
    <?= $block->getBlockHtml('formkey') ?>
    <input type="hidden" name="item_id" :value="item.item_id">

    <div class="<?= $wrap ?>">
      <!-- - -->
      <button
        type="button"
        class="<?= $btnL ?>"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Decrease quantity')) ?>"
        @click="decrement()"
        <?= /* @noEscape */ $autoSaveDebounceAttr ?>
      >
        <?= $heroicons->minusHtml('w-3.5 h-3.5 text-gray-600', 14, 14, ['aria-hidden' => 'true']); ?>
      </button>

      <!-- REAL INPUT (vyzerá ako span) -->
      <label class="sr-only">
        <span class="sr-only"><?= $escaper->escapeHtml(__('Qty')) ?></span>
      </label>

      <input
        x-ref="qtyInput"
        type="number"
        name="item_qty"
        required
        min="1"
        step="1"
        x-model.number="itemQty"
        class="<?= $inputClass ?>
          [appearance:textfield]
          [&::-webkit-inner-spin-button]:hidden
          [&::-webkit-outer-spin-button]:hidden
        "
        @change="updateQtyValue"
        <?= /* @noEscape */ $autoSaveChangeAttr ?>
        <?php if ($miniCartOptionQtyStyle === "select"): ?>
          list="minicart-autocomplete"
          @focus="updateQtyOnFocus"
          @blur="updateQtyOnBlur"
        <?php endif; ?>
      >

      <!-- + -->
      <button
        type="button"
        class="<?= $btnR ?>"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Increase quantity')) ?>"
        @click="increment()"
        <?= /* @noEscape */ $autoSaveDebounceAttr ?>
      >
        <?= $heroicons->plusHtml('w-3.5 h-3.5 text-gray-600', 14, 14, ['aria-hidden' => 'true']); ?>
      </button>
    </div>

    <?php if (!$miniCartOptionQtySaveAuto): ?>
      <!-- POTVRDENIE ostáva po starom -->
      <button
        type="submit"
        class="inline-flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-white hover:opacity-90 transition disabled:invisible"
        :disabled="qtyHasNewValue"
        data-aria-label="<?= $escaper->escapeJs(__('Update qty for "%1"')) ?>"
        :aria-label="item.product_name"
      >
        <?= $heroiconsSolid->checkHtml('', 20, 20, ['aria-hidden' => 'true']); ?>
      </button>
    <?php endif; ?>
  </form>
<?php endif; ?>
