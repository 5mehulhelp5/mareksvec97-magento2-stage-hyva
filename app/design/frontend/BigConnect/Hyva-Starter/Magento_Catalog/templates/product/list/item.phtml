<?php
declare(strict_types=1);

use Magento\Catalog\Block\Product\ListProduct;
use Magento\Catalog\Model\Product;
use Magento\Framework\Escaper;
use Magento\Framework\App\ObjectManager;
use Magento\Framework\Pricing\Helper\Data as PriceHelper;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;

/** @var ListProduct $block */
/** @var Escaper $escaper */

$product = $block->getProduct();
if (!$product instanceof Product) {
    return;
}

$om = ObjectManager::getInstance();

/** Heroicons (nezávislé od $viewModels) */
$heroicons = null;
try {
    /** @var ViewModelRegistry $vmr */
    $vmr = $om->get(ViewModelRegistry::class);
    $heroicons = $vmr->require(HeroiconsOutline::class);
} catch (\Throwable $e) {
    $heroicons = null;
}

$productName = (string) $product->getName();
$productUrl  = (string) $product->getProductUrl();

$imageDisplayArea = 'category_page_grid';
$imageCustomAttributes = ['loading' => 'lazy'];

$templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW;

/** @var PriceHelper $priceHelper */
$priceHelper = $om->get(PriceHelper::class);

$regularPrice = (float) $product->getPriceInfo()->getPrice('regular_price')->getValue();
$finalPrice   = (float) $product->getPriceInfo()->getPrice('final_price')->getValue();

$hasDiscount = $finalPrice > 0 && $regularPrice > 0 && $finalPrice < $regularPrice;

$finalPriceHtml   = $priceHelper->currency($finalPrice, true, false);
$regularPriceHtml = $priceHelper->currency($regularPrice, true, false);

$finalPriceText   = trim((string) strip_tags($finalPriceHtml));
$regularPriceText = trim((string) strip_tags($regularPriceHtml));

$imageUrl = '';
try {
    $img = $block->getImage($product, $imageDisplayArea);
    $imageUrl = (string) $img->getImageUrl();
} catch (\Throwable $e) {
    $imageUrl = '';
}

/** Add to cart post */
$post = $block->getAddToCartPostParams($product);
$hasPost = is_array($post) && !empty($post['action']) && !empty($post['data']) && is_array($post['data']);
$formId = 'quickadd-form-' . (int) $product->getId();

/** Modal payload (bez rozbitia JS) */
$payload = [
    'formId' => $hasPost ? $formId : null,
    'productId' => (int) $product->getId(),
    'name' => $productName,
    'url' => $productUrl,
    'image' => $imageUrl,
    'price' => $finalPriceText,
    'originalPrice' => $hasDiscount ? $regularPriceText : '',
    'qty' => 1,
];
$payloadJson = json_encode($payload, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
?>

<div class="group bg-white rounded-xl border border-border overflow-hidden hover:shadow-xl transition-all duration-300">
	
    <!-- IMAGE -->
    <div class="relative aspect-square bg-secondary overflow-hidden">
        <a href="<?= $escaper->escapeUrl($productUrl) ?>"
           class="block w-full h-full"
           aria-label="<?= $escaper->escapeHtmlAttr($productName) ?>"
           tabindex="-1"
        >
            <?php
            $imgAttrs = $imageCustomAttributes;
            $imgAttrs['class'] = 'w-full h-full object-cover group-hover:scale-110 transition-transform duration-500';

            echo $block->getImage($product, $imageDisplayArea)
                ->setTemplate('Magento_Catalog::product/list/image.phtml')
                ->setData('custom_attributes', $imgAttrs)
                ->toHtml();
            ?>
        </a>
        <?= $block->getLayout()
            ->createBlock(\Magento\Framework\View\Element\Template::class)
            ->setTemplate('Magento_Theme::elements/badges/product-discount-badge.phtml')
            ->setData('product', $product)
            ->toHtml()
        ?>
    </div>

    <!-- CONTENT -->
    <div class="p-4">
        <a href="<?= $escaper->escapeUrl($productUrl) ?>" class="block">
            <h3 class="mb-2 line-clamp-2 text-sm md:text-base min-h-[2.5rem] hover:text-primary transition-colors">
                <?= $escaper->escapeHtml($productName) ?>
            </h3>
        </a>

        <!-- RATING -->
        <div class="mb-3">
            <?= /* @noEscape */ $block->getReviewsSummaryHtml($product, $templateType, true) ?>
        </div>

        <!-- PRICE -->
        <div class="flex items-center gap-2 mb-4">
            <span class="font-bold text-primary text-base md:text-xl">
                <?= /* @noEscape */ $finalPriceHtml ?>
            </span>

            <?php if ($hasDiscount): ?>
                <span class="text-xs md:text-sm text-muted line-through">
                    <?= /* @noEscape */ $regularPriceHtml ?>
                </span>
            <?php endif; ?>
        </div>

        <!-- ACTION -->
        <?php if (!$product->isSaleable()): ?>
            <a href="<?= $escaper->escapeUrl($productUrl) ?>"
               class="w-full inline-flex items-center justify-center h-9 px-4 py-2 rounded-md text-sm font-medium transition-all text-white bg-primary hover:bg-primary/90"
            >
                <span><?= $escaper->escapeHtml(__('View Product')) ?></span>
            </a>
        <?php else: ?>
            <?php if ($hasPost): ?>
                <form
                    id="<?= $escaper->escapeHtmlAttr($formId) ?>"
                    data-role="tocart-form"
                    action="<?= $escaper->escapeUrl((string) $post['action']) ?>"
                    method="post"
                    class="w-full"
                >
                    <?php foreach ($post['data'] as $k => $v): ?>
                        <input type="hidden"
                               name="<?= $escaper->escapeHtmlAttr((string) $k) ?>"
                               value="<?= $escaper->escapeHtmlAttr((string) $v) ?>">
                    <?php endforeach; ?>
                    <input type="hidden" name="qty" value="1" />

                    <button
                        type="button"
                        class="w-full text-white flex items-center justify-center gap-2 h-9 px-4 py-2 rounded-md text-sm font-medium transition-all bg-primary hover:bg-primary/90"
                        onclick='window.dispatchEvent(new CustomEvent("open-quick-add",{detail: <?= /* @noEscape */ $payloadJson ?> }))'
                    >
                        <?php if ($heroicons): ?>
                            <?= $heroicons->shoppingCartHtml('text-white', 20, 20, ['aria-hidden' => 'true']) ?>
                        <?php endif; ?>
                        <span><?= $escaper->escapeHtml(__('Add to Cart')) ?></span>
                    </button>
                </form>
            <?php else: ?>
                <button
                    type="button"
                    class="w-full text-white flex items-center justify-center gap-2 h-9 px-4 py-2 rounded-md text-sm font-medium transition-all bg-primary hover:bg-primary/90"
                    onclick='window.dispatchEvent(new CustomEvent("open-quick-add",{detail: <?= /* @noEscape */ $payloadJson ?> }))'
                >
                    <?php if ($heroicons): ?>
                        <?= $heroicons->shoppingCartHtml('text-white', 20, 20, ['aria-hidden' => 'true']) ?>
                    <?php endif; ?>
                    <span><?= $escaper->escapeHtml(__('Vybrať možnosti')) ?></span>
                </button>
            <?php endif; ?>
        <?php endif; ?>
    </div>
</div>
