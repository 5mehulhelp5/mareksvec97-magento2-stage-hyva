<?php
declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Framework\App\ObjectManager;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsSolid;

/** @var Escaper $escaper */

$om = ObjectManager::getInstance();
/** @var ViewModelRegistry $vmr */
$vmr = $om->get(ViewModelRegistry::class);
/** @var HeroiconsSolid $heroicons */
$heroicons = $vmr->require(HeroiconsSolid::class);
?>

<script>
(function () {
  'use strict';

  function qs(sel, root) { return (root || document).querySelector(sel); }

  function openDialog(dialog) {
    if (!dialog) return;
    document.documentElement.classList.add('overflow-hidden');
    if (typeof dialog.showModal === 'function' && !dialog.open) dialog.showModal();
    dialog.setAttribute('data-open', '1');
  }

  function closeDialog(dialog) {
    if (!dialog) return;
    document.documentElement.classList.remove('overflow-hidden');
    if (typeof dialog.close === 'function' && dialog.open) dialog.close();
    dialog.removeAttribute('data-open');
  }

  function setText(el, value) {
    if (!el) return;
    el.textContent = value || '';
  }

  function setAttr(el, attr, value) {
    if (!el) return;
    if (value) el.setAttribute(attr, value);
    else el.removeAttribute(attr);
  }

  function setVisible(el, visible) {
    if (!el) return;
    el.style.display = visible ? '' : 'none';
  }

  function setData(dialog, detail) {
    const d = detail || {};

    dialog.dataset.formId = d.formId || '';

    setText(qs('[data-qa-name]', dialog), d.name || '');
    setAttr(qs('[data-qa-link]', dialog), 'href', d.url || '');
    setVisible(qs('[data-qa-link-wrap]', dialog), !!d.url);

    const img = qs('[data-qa-img]', dialog);
    if (img) {
      img.src = d.image || '';
      img.alt = d.name || '';
    }

    setText(qs('[data-qa-price]', dialog), d.price || '');
    setText(qs('[data-qa-original-price]', dialog), d.originalPrice || '');
    setVisible(qs('[data-qa-original-price]', dialog), !!d.originalPrice);

    const qty = qs('[data-qa-qty]', dialog);
    if (qty) {
      const n = parseInt(d.qty || '1', 10);
      qty.value = (!Number.isFinite(n) || n < 1) ? 1 : n;
    }

    // CTA: Add to cart len keď máme formId
    setVisible(qs('[data-qa-submit]', dialog), !!d.formId);
    setVisible(qs('[data-qa-needs-options]', dialog), !d.formId);
  }

  function submit(dialog) {
    const formId = dialog.dataset.formId || '';
    if (!formId) return;

    const form = document.getElementById(formId);
    if (!form) return;

    const qtyInputModal = qs('[data-qa-qty]', dialog);
    const qtyVal = qtyInputModal ? String(qtyInputModal.value || '1') : '1';

    let qtyInput = form.querySelector('input[name="qty"]');
    if (!qtyInput) {
      qtyInput = document.createElement('input');
      qtyInput.type = 'hidden';
      qtyInput.name = 'qty';
      form.appendChild(qtyInput);
    }
    qtyInput.value = qtyVal;

    if (typeof form.requestSubmit === 'function') form.requestSubmit();
    else form.submit();

    closeDialog(dialog);
  }

  document.addEventListener('DOMContentLoaded', function () {
    const dialog = document.getElementById('quick-add-dialog');
    if (!dialog) return;

    // Open listener
    window.addEventListener('open-quick-add', function (e) {
      try {
        setData(dialog, (e && e.detail) ? e.detail : {});
        openDialog(dialog);
      } catch (err) {
        console.error('QuickAdd error:', err);
      }
    });

    // Close handlers
    dialog.addEventListener('click', function (e) {
      if (e.target === dialog) closeDialog(dialog); // click on backdrop
    });

    const closeBtn = qs('[data-qa-close]', dialog);
    if (closeBtn) closeBtn.addEventListener('click', function () { closeDialog(dialog); });

    dialog.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        e.preventDefault();
        closeDialog(dialog);
      }
    });

    // Qty buttons
    const decBtn = qs('[data-qa-dec]', dialog);
    const incBtn = qs('[data-qa-inc]', dialog);
    const qtyInp = qs('[data-qa-qty]', dialog);

    function clampQty(n) {
      n = parseInt(n, 10);
      if (!Number.isFinite(n) || n < 1) n = 1;
      if (n > 999) n = 999;
      return n;
    }

    if (decBtn && qtyInp) decBtn.addEventListener('click', function () {
      qtyInp.value = clampQty(qtyInp.value) - 1;
      qtyInp.value = clampQty(qtyInp.value);
    });

    if (incBtn && qtyInp) incBtn.addEventListener('click', function () {
      qtyInp.value = clampQty(qtyInp.value) + 1;
      qtyInp.value = clampQty(qtyInp.value);
    });

    // Submit
    const submitBtn = qs('[data-qa-submit]', dialog);
    if (submitBtn) submitBtn.addEventListener('click', function () { submit(dialog); });
  });
})();
</script>

<dialog
  id="quick-add-dialog"
  class="w-full max-w-2xl rounded-2xl bg-white text-text p-0 shadow-2xl
         backdrop:bg-black/50 backdrop:backdrop-blur-sm"
>
  <!-- Header -->
  <div class="sticky top-0 bg-white border-b border-border px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between rounded-t-2xl z-10">
    <div class="flex items-center gap-3 flex-1 min-w-0">
      <h3 class="font-bold text-base sm:text-lg truncate">
        <?= $escaper->escapeHtml(__('Vyber možnosti')) ?>
      </h3>

      <span data-qa-link-wrap class="hidden sm:inline-flex">
        <a
          data-qa-link
          href="#"
          class="inline-flex items-center gap-1.5 text-sm font-medium text-primary hover:text-primary-darker transition-colors whitespace-nowrap"
        >
          <?= $heroicons->externalLinkHtml('w-4 h-4', 20, 20, ['aria-hidden' => 'true']); ?>
          <span><?= $escaper->escapeHtml(__('Prejsť na produkt')) ?></span>
        </a>
      </span>
    </div>

    <button
      type="button"
      data-qa-close
      class="p-2 hover:bg-secondary-lighter rounded-lg transition-colors flex-shrink-0"
      aria-label="<?= $escaper->escapeHtmlAttr(__('Close')) ?>"
      title="<?= $escaper->escapeHtmlAttr(__('Close')) ?>"
    >
      <?= $heroicons->xHtml('w-5 h-5 text-muted', 20, 20, ['aria-hidden' => 'true']); ?>
    </button>
  </div>

  <!-- Content -->
  <div class="p-4 sm:p-6">
    <div class="flex gap-3 sm:gap-4 mb-4 sm:mb-6 pb-4 sm:pb-6 border-b border-border">
      <div class="w-20 h-20 sm:w-24 sm:h-24 bg-secondary-lighter rounded-lg overflow-hidden flex-shrink-0">
        <img data-qa-img src="" alt="" class="w-full h-full object-cover" loading="lazy"/>
      </div>

      <div class="flex-1 min-w-0">
        <h4 class="font-semibold text-sm sm:text-base mb-2 line-clamp-2" data-qa-name></h4>

        <div class="flex items-center gap-2 flex-wrap">
          <span class="font-bold text-lg sm:text-xl text-primary" data-qa-price></span>

          <span class="text-xs sm:text-sm text-muted line-through" data-qa-original-price style="display:none;"></span>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <label class="block font-medium text-sm mb-3">
        <?= $escaper->escapeHtml(__('Množstvo')) ?>
      </label>

      <div class="inline-flex items-center border-2 border-border rounded-lg overflow-hidden bg-white">
        <button type="button" data-qa-dec class="p-3 hover:bg-secondary-lighter transition-colors" aria-label="<?= $escaper->escapeHtmlAttr(__('Decrease quantity')) ?>">
          <?= $heroicons->minusHtml('w-5 h-5', 20, 20, ['aria-hidden' => 'true']); ?>
        </button>

        <input
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          value="1"
          data-qa-qty
          class="w-16 text-center font-medium bg-white text-base border-0 focus:ring-0"
          aria-label="<?= $escaper->escapeHtmlAttr(__('Množstvo')) ?>"
        />

        <button type="button" data-qa-inc class="p-3 hover:bg-secondary-lighter transition-colors" aria-label="<?= $escaper->escapeHtmlAttr(__('Increase quantity')) ?>">
          <?= $heroicons->plusHtml('w-5 h-5', 20, 20, ['aria-hidden' => 'true']); ?>
        </button>
      </div>

      <div data-qa-needs-options class="mt-3 text-sm text-muted" style="display:none;">
        <?= $escaper->escapeHtml(__('Tento produkt vyžaduje výber možností.')) ?>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="sticky bottom-0 bg-white border-t border-border px-4 sm:px-6 py-4 rounded-b-2xl">
    <div class="flex flex-col sm:flex-row gap-3">
      <button
        type="button"
        data-qa-submit
        class="w-full inline-flex items-center justify-center gap-2 py-3 text-base font-semibold rounded-lg
               bg-primary text-white hover:bg-primary-darker transition-colors"
        style="display:none;"
      >
        <?= $heroicons->shoppingCartHtml('w-5 h-5', 22, 22, ['aria-hidden' => 'true']); ?>
        <span><?= $escaper->escapeHtml(__('Pridať do košíka')) ?></span>
      </button>

      <a
        data-qa-link
        href="#"
        class="w-full inline-flex items-center justify-center gap-2 py-3 text-base font-semibold rounded-lg
               border-2 border-primary text-primary hover:bg-primary/5 transition-colors"
      >
        <?= $heroicons->eyeHtml('w-5 h-5', 22, 22, ['aria-hidden' => 'true']); ?>
        <span><?= $escaper->escapeHtml(__('Zobraziť detail')) ?></span>
      </a>
    </div>
  </div>
</dialog>
