<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Store;
use Hyva\Theme\ViewModel\StoreSwitcher;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Store\ViewModel\SwitcherUrlProvider;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$switcherUrlProvider = $viewModels->require(SwitcherUrlProvider::class);
$storeViewModel = $viewModels->require(Store::class);
$storeSwitcherViewModel = $viewModels->require(StoreSwitcher::class);

$currentStore = $storeSwitcherViewModel->getStore();
$stores = $storeSwitcherViewModel->getStores();

$normalizeFlagCode = static function (string $storeCode): string {
    $code = strtolower(trim($storeCode));
    $code = str_replace('-', '_', $code);
    $parts = array_values(array_filter(explode('_', $code)));
    if (!$parts) return 'en';

    $last = end($parts);
    if (preg_match('/^[a-z]{2}$/', (string) $last)) {
        return (string) $last; // sk, cz, de...
    }
    $fallback = substr((string) $parts[0], 0, 2);
    return $fallback ?: 'en';
};

$countryLabelFromFlag = static function (string $flagCode): string {
    $map = [
        'sk' => 'Slovensko',
        'cz' => 'Česko',
        'cs' => 'Česko',
        'de' => 'Deutschland',
        'at' => 'Österreich',
        'hu' => 'Magyarország',
        'pl' => 'Polska',
        'ro' => 'România',
        'it' => 'Italia',
        'fr' => 'France',
        'es' => 'España',
        'nl' => 'Nederland',
        'be' => 'België',
        'dk' => 'Danmark',
        'se' => 'Sverige',
        'fi' => 'Suomi',
        'ie' => 'Ireland',
        'pt' => 'Portugal',
        'gr' => 'Ελλάδα',
        'el' => 'Ελλάδα',
        'bg' => 'България',
        'hr' => 'Hrvatska',
        'si' => 'Slovenija',
        'ee' => 'Eesti',
        'lv' => 'Latvija',
        'lt' => 'Lietuva',
        'lu' => 'Luxembourg',
        'mt' => 'Malta',
        'cy' => 'Κύπρος',
    ];
    return $map[$flagCode] ?? strtoupper($flagCode);
};

$shortCodeFromFlag = static function (string $flagCode): string {
    return strtoupper($flagCode);
};

// Figma-like: images/flags/sk1.svg...
$flagSvgUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/' . $flagCode . '1.svg');
};
$flagPngUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/circle/' . $flagCode . '.png');
};

$domainFromUrl = static function (string $url): string {
    $host = parse_url($url, PHP_URL_HOST);
    return $host ?: $url;
};

$currentFlagCode = $normalizeFlagCode((string) $currentStore->getCode());
$currentShort    = $shortCodeFromFlag($currentFlagCode);

$uniqueId = '_' . uniqid();
?>

<?php if (count($stores) > 1): ?>
<div
    x-data="initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>()"
    class="relative inline-flex"
>
    <!-- MOBILE trigger: flag only -->
    <div class="relative md:hidden">
        <button
            type="button"
            class="p-2 rounded-lg hover:bg-gray-50 transition-colors border border-gray-200"
            @click.prevent="openPanel()"
            @keydown.window.escape="closeAll()"
            aria-haspopup="true"
            :aria-expanded="panelOpen ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />
        </button>
    </div>

    <!-- DESKTOP trigger: dropdown -->
    <div class="relative hidden md:block">
        <button
            type="button"
            class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors border border-gray-200"
            @click.prevent="toggleDropdown()"
            @keydown.window.escape="closeAll()"
            aria-haspopup="true"
            :aria-expanded="dropdownOpen ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />
            <span class="text-gray-600 text-sm font-medium">
                <?= $escaper->escapeHtml($currentShort) ?>
            </span>

            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                 class="w-3.5 h-3.5 text-gray-500 transition-transform"
                 :class="dropdownOpen ? 'rotate-180' : ''"
                 aria-hidden="true">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
        </button>

        <!-- DESKTOP Backdrop -->
        <div
            x-cloak
            x-show="dropdownOpen"
            class="fixed inset-0 z-40"
            @click="closeAll()"
            aria-hidden="true"
        ></div>

        <!-- DESKTOP Dropdown -->
        <div
            x-cloak
            x-show="dropdownOpen"
            x-transition.origin.top.right
            class="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50 overflow-hidden"
            role="menu"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Choose your language')) ?>"
        >
            <div class="px-3 py-2 border-b border-gray-100">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
                    <?= $escaper->escapeHtml(__('Select country')) ?>
                </p>
            </div>

            <div class="py-1">
                <?php foreach ($stores as $lang): ?>
                    <?php
                    $isCurrent = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                    $langFlagCode = $normalizeFlagCode((string) $lang->getCode());
                    $langUrl = (string) $switcherUrlProvider->getTargetStoreRedirectUrl($lang);
                    $langDomain = $domainFromUrl($langUrl);
                    $countryLabel = $countryLabelFromFlag($langFlagCode);
                    ?>

                    <?php if ($isCurrent): ?>
                        <div class="flex items-center gap-3 px-4 py-2.5 opacity-60 cursor-default" role="menuitem" aria-current="true">
                            <img
                                src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                                alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-gray-200"
                                width="24" height="24"
                                loading="lazy" decoding="async"
                            />
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 text-sm"><?= $escaper->escapeHtml($countryLabel) ?></div>
                                <div class="text-xs text-gray-500"><?= $escaper->escapeHtml($langDomain) ?></div>
                            </div>
                            <span class="text-xs font-semibold text-gray-500">
                                <?= $escaper->escapeHtml($shortCodeFromFlag($langFlagCode)) ?>
                            </span>
                        </div>
                    <?php else: ?>
                        <a
                            href="<?= $escaper->escapeUrl($langUrl) ?>"
                            class="flex items-center gap-3 px-4 py-2.5 transition-colors group hover:bg-gray-50"
                            role="menuitem"
                            @click="closeAll()"
                        >
                            <img
                                src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                                alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-gray-200"
                                width="24" height="24"
                                loading="lazy" decoding="async"
                            />
                            <div class="flex-1">
                                <div class="font-medium text-gray-900 text-sm"><?= $escaper->escapeHtml($countryLabel) ?></div>
                                <div class="text-xs text-gray-500"><?= $escaper->escapeHtml($langDomain) ?></div>
                            </div>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </div>
    </div>

    <!-- MOBILE overlay -->
    <div
        x-cloak
        x-show="panelOpen"
        x-transition.opacity.duration.300ms
        class="fixed inset-0 bg-black/50 z-40"
        @click="closeAll()"
        aria-hidden="true"
    ></div>

    <!-- MOBILE slide panel -->
    <div
        x-cloak
        x-show="panelOpen"
        x-transition:enter="transition transform duration-300 ease-in-out"
        x-transition:enter-start="translate-x-full"
        x-transition:enter-end="translate-x-0"
        x-transition:leave="transition transform duration-300 ease-in-out"
        x-transition:leave-start="translate-x-0"
        x-transition:leave-end="translate-x-full"
        class="fixed top-0 right-0 h-full bg-white shadow-2xl z-50 w-full max-w-sm"
        role="dialog"
        aria-modal="true"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Select country')) ?>"
    >
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="px-6 py-5 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-lg text-gray-900"><?= $escaper->escapeHtml(__('Výber krajiny')) ?></h2>

                    <button
                        type="button"
                        @click="closeAll()"
                        class="w-10 h-10 flex items-center justify-center hover:bg-gray-100 rounded-lg transition-colors"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Close')) ?>"
                    >
                        <!-- X icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="w-5 h-5 text-gray-500" aria-hidden="true">
                            <path d="M18 6 6 18"></path>
                            <path d="M6 6 18 18"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Languages list -->
            <div class="flex-1 overflow-y-auto px-6 py-6">
                <div class="space-y-2">
                    <?php foreach ($stores as $lang): ?>
                        <?php
                        $isCurrent = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                        $langFlagCode = $normalizeFlagCode((string) $lang->getCode());
                        $langUrl = (string) $switcherUrlProvider->getTargetStoreRedirectUrl($lang);
                        $langDomain = $domainFromUrl($langUrl);
                        $countryLabel = $countryLabelFromFlag($langFlagCode);
                        ?>

                        <?php if ($isCurrent): ?>
                            <div
                                class="w-full flex items-center gap-4 p-4 bg-gray-50 rounded-lg border border-gray-200 opacity-70"
                                aria-current="true"
                            >
                                <img
                                    src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                                    onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                                    alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                    class="w-8 h-8 rounded-full object-cover"
                                    width="32" height="32"
                                    loading="lazy" decoding="async"
                                />
                                <div class="text-left flex-1">
                                    <div class="font-semibold text-gray-900 text-base"><?= $escaper->escapeHtml($countryLabel) ?></div>
                                    <div class="text-sm text-gray-500"><?= $escaper->escapeHtml($langDomain) ?></div>
                                </div>
                            </div>
                        <?php else: ?>
                            <a
                                href="<?= $escaper->escapeUrl($langUrl) ?>"
                                class="w-full flex items-center gap-4 p-4 bg-white rounded-lg border border-gray-200 hover:border-[#7e9b84] hover:bg-gray-50 transition-all"
                                @click="closeAll()"
                            >
                                <img
                                    src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                                    onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                                    alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                    class="w-8 h-8 rounded-full object-cover"
                                    width="32" height="32"
                                    loading="lazy" decoding="async"
                                />
                                <div class="text-left flex-1">
                                    <div class="font-semibold text-gray-900 text-base"><?= $escaper->escapeHtml($countryLabel) ?></div>
                                    <div class="text-sm text-gray-500"><?= $escaper->escapeHtml($langDomain) ?></div>
                                </div>
                            </a>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
'use strict';
function initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>() {
    return {
        dropdownOpen: false,
        panelOpen: false,

        toggleDropdown() {
            this.panelOpen = false;
            this.dropdownOpen = !this.dropdownOpen;
        },

        openPanel() {
            this.dropdownOpen = false;
            this.panelOpen = true;
            document.documentElement.classList.add('overflow-hidden');
        },

        closeAll() {
            this.dropdownOpen = false;
            this.panelOpen = false;
            document.documentElement.classList.remove('overflow-hidden');
        },
    }
}
window.addEventListener(
    'alpine:init',
    () => Alpine.data(
        'initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>',
        initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>
    ),
    { once: true }
);
</script>

<?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>
