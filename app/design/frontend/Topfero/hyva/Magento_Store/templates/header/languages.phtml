<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Store;
use Hyva\Theme\ViewModel\StoreSwitcher;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Store\ViewModel\SwitcherUrlProvider;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$switcherUrlProvider     = $viewModels->require(SwitcherUrlProvider::class);
$storeViewModel          = $viewModels->require(Store::class);
$storeSwitcherViewModel  = $viewModels->require(StoreSwitcher::class);

$currentStore = $storeSwitcherViewModel->getStore();
$stores       = $storeSwitcherViewModel->getStores();

$normalizeFlagCode = static function (string $storeCode): string {
    $code = strtolower(trim($storeCode));
    $code = str_replace('-', '_', $code);
    $parts = array_values(array_filter(explode('_', $code)));
    if (!$parts) return 'en';

    $last = end($parts);
    if (preg_match('/^[a-z]{2}$/', (string) $last)) {
        return (string) $last; // sk, cz, de...
    }
    $fallback = substr((string) $parts[0], 0, 2);
    return $fallback ?: 'en';
};

$countryLabelFromFlag = static function (string $flagCode): string {
    $map = [
        'sk' => 'Slovensko',
        'cz' => 'Česká republika', 'cs' => 'Česká republika',
        'de' => 'Deutschland',
        'at' => 'Österreich',
        'hu' => 'Magyarország',
        'pl' => 'Polska',
        'ro' => 'România',
        'it' => 'Italia',
        'fr' => 'France',
        'es' => 'España',
        'nl' => 'Nederland',
        'be' => 'België',
        'dk' => 'Danmark',
        'se' => 'Sverige',
        'fi' => 'Suomi',
        'ie' => 'Ireland',
        'pt' => 'Portugal',
        'gr' => 'Ελλάδα', 'el' => 'Ελλάδα',
        'bg' => 'България',
        'hr' => 'Hrvatska',
        'si' => 'Slovenija',
        'ee' => 'Eesti',
        'lv' => 'Latvija',
        'lt' => 'Lietuva',
        'lu' => 'Luxembourg',
        'mt' => 'Malta',
        'cy' => 'Κύπρος',
    ];
    return $map[$flagCode] ?? strtoupper($flagCode);
};

$shortCodeFromFlag = static function (string $flagCode): string {
    return strtoupper($flagCode);
};

$flagSvgUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/' . $flagCode . '1.svg');
};

$flagPngUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/circle/' . $flagCode . '.png');
};

$domainFromUrl = static function (string $url): string {
    $host = parse_url($url, PHP_URL_HOST);
    return $host ?: $url;
};

$currentFlagCode = $normalizeFlagCode((string) $currentStore->getCode());
$currentShort    = $shortCodeFromFlag($currentFlagCode);

$uniqueId = '_' . uniqid();
?>

<?php if (count($stores) > 1): ?>
<div
    x-data="initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>()"
    class="relative inline-flex"
>
    <!-- MOBILE -->
    <div class="relative md:hidden">
        <button
            type="button"
            class="p-2 rounded-lg transition-colors border border-border hover:bg-secondary-lighter"
            @click.prevent="openPanel()"
            @keydown.window.escape="closeAll()"
            aria-haspopup="true"
            :aria-expanded="panelOpen ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />
        </button>
    </div>

    <!-- DESKTOP: flag + SK + chevron -->
    <div class="relative hidden md:block lg:block">
        <button
            type="button"
            class="flex items-center gap-2 px-3 py-2 rounded-lg transition-colors border border-border hover:bg-secondary-lighter"
            @click.prevent="toggleDesktop()"
            @keydown.window.escape="closeAll()"
            aria-haspopup="true"
            :aria-expanded="desktopOpen ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />

            <span class="text-muted text-sm font-medium">
                <?= $escaper->escapeHtml($currentShort) ?>
            </span>

            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                 class="w-3.5 h-3.5 text-muted transition-transform"
                 :class="desktopOpen ? 'rotate-180' : ''"
                 aria-hidden="true">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
        </button>
    </div>

    <!-- DESKTOP BACKDROP -->
    <div
        x-cloak
        x-show="desktopOpen"
        class="fixed inset-0 z-40"
        @click="desktopOpen = false"
        aria-hidden="true"
    ></div>

    <!-- DESKTOP DROPDOWN -->
    <div
        x-cloak
        x-show="desktopOpen"
        x-transition.origin.top.right
        class="absolute top-full right-0 mt-2 w-56 bg-container rounded-xl shadow-xl border border-border py-2 z-50 overflow-hidden hidden md:block"
        role="menu"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Choose your language')) ?>"
    >
        <div class="px-3 py-2 border-b border-border-lighter">
            <p class="text-xs font-semibold text-muted uppercase tracking-wide">
                <?= $escaper->escapeHtml(__('Select country')) ?>
            </p>
        </div>

        <div class="py-1">
            <?php foreach ($stores as $lang): ?>
                <?php
                $isCurrent   = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                $langFlag    = $normalizeFlagCode((string) $lang->getCode());
                $langUrl     = (string) $switcherUrlProvider->getTargetStoreRedirectUrl($lang);
                $langDomain  = $domainFromUrl($langUrl);
                $countryName = $countryLabelFromFlag($langFlag);
                ?>

                <?php if ($isCurrent): ?>
                    <div class="flex items-center gap-3 px-4 py-2.5 opacity-60 cursor-default" role="menuitem" aria-current="true">
                        <img
                            src="<?= $escaper->escapeUrl($flagSvgUrl($langFlag)) ?>"
                            onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlag)) ?>';"
                            alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                            class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-border"
                            width="24" height="24" loading="lazy" decoding="async"
                        />
                        <div class="flex-1">
                            <div class="font-medium text-text text-sm"><?= $escaper->escapeHtml($countryName) ?></div>
                            <div class="text-xs text-muted"><?= $escaper->escapeHtml($langDomain) ?></div>
                        </div>
                        <span class="text-xs font-semibold text-muted"><?= $escaper->escapeHtml($shortCodeFromFlag($langFlag)) ?></span>
                    </div>
                <?php else: ?>
                    <a
                        href="<?= $escaper->escapeUrl($langUrl) ?>"
                        class="flex items-center gap-3 px-4 py-2.5 transition-colors hover:bg-secondary-lighter"
                        role="menuitem"
                        @click="closeAll()"
                    >
                        <img
                            src="<?= $escaper->escapeUrl($flagSvgUrl($langFlag)) ?>"
                            onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlag)) ?>';"
                            alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                            class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-border"
                            width="24" height="24" loading="lazy" decoding="async"
                        />
                        <div class="flex-1">
                            <div class="font-medium text-text text-sm"><?= $escaper->escapeHtml($countryName) ?></div>
                            <div class="text-xs text-muted"><?= $escaper->escapeHtml($langDomain) ?></div>
                        </div>
                    </a>
                <?php endif; ?>
            <?php endforeach; ?>
        </div>
    </div>

    <!-- MOBILE OVERLAY -->
    <div
        x-cloak
        class="fixed inset-0 bg-black/50 transition-opacity z-40 md:hidden"
        :class="panelOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'"
        @click="closeAll()"
        aria-hidden="true"
    ></div>

    <!-- MOBILE SLIDE PANEL -->
    <div
        x-cloak
        class="fixed top-0 right-0 h-full bg-container shadow-2xl z-50 md:hidden
               w-[90vw] max-w-sm transform transition-transform duration-300 ease-in-out"
        :class="panelOpen ? 'translate-x-0' : 'translate-x-full'"
        role="dialog"
        aria-modal="true"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Výber krajiny')) ?>"
    >
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="px-5 py-4 border-b border-border">
                <div class="flex items-center justify-between">
                    <h2 class="font-bold text-base text-text">
                        <?= $escaper->escapeHtml(__('Výber krajiny')) ?>
                    </h2>
                    <button
                        type="button"
                        @click="closeAll()"
                        class="w-9 h-9 flex items-center justify-center rounded-lg transition-colors hover:bg-secondary-lighter"
                        aria-label="<?= $escaper->escapeHtmlAttr(__('Close')) ?>"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                             class="w-5 h-5 text-muted" aria-hidden="true">
                            <path d="M18 6 6 18"></path>
                            <path d="m6 6 12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- List -->
            <div class="flex-1 overflow-y-auto px-4 py-4">
                <div class="space-y-2">
                    <?php foreach ($stores as $lang): ?>
                        <?php
                        $isCurrent   = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());
                        $langFlag    = $normalizeFlagCode((string) $lang->getCode());
                        $langUrl     = (string) $switcherUrlProvider->getTargetStoreRedirectUrl($lang);
                        $langDomain  = $domainFromUrl($langUrl);
                        $countryName = $countryLabelFromFlag($langFlag);
                        ?>

                        <?php if ($isCurrent): ?>
                            <div
                                class="w-full flex items-center gap-3 p-3 bg-container rounded-lg border border-border opacity-70"
                                aria-current="true"
                            >
                                <img
                                    src="<?= $escaper->escapeUrl($flagSvgUrl($langFlag)) ?>"
                                    onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlag)) ?>';"
                                    alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                    class="w-7 h-7 rounded-full object-cover flex-shrink-0"
                                    width="28" height="28" loading="lazy" decoding="async"
                                />
                                <div class="text-left flex-1">
                                    <h3 class="font-semibold text-text text-[15px] leading-tight">
                                        <?= $escaper->escapeHtml($countryName) ?>
                                    </h3>
                                    <p class="text-xs text-muted mt-0.5">
                                        <?= $escaper->escapeHtml($langDomain) ?>
                                    </p>
                                </div>
                            </div>
                        <?php else: ?>
                            <a
                                href="<?= $escaper->escapeUrl($langUrl) ?>"
                                class="w-full flex items-center gap-3 p-3 bg-container rounded-lg border border-border
                                       transition-all hover:border-primary hover:bg-secondary-lighter"
                                @click="closeAll()"
                            >
                                <img
                                    src="<?= $escaper->escapeUrl($flagSvgUrl($langFlag)) ?>"
                                    onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlag)) ?>';"
                                    alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                                    class="w-7 h-7 rounded-full object-cover flex-shrink-0"
                                    width="28" height="28" loading="lazy" decoding="async"
                                />
                                <div class="text-left flex-1">
                                    <h3 class="font-semibold text-text text-[15px] leading-tight">
                                        <?= $escaper->escapeHtml($countryName) ?>
                                    </h3>
                                    <p class="text-xs text-muted mt-0.5">
                                        <?= $escaper->escapeHtml($langDomain) ?>
                                    </p>
                                </div>
                            </a>
                        <?php endif; ?>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
'use strict';
function initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>() {
    return {
        panelOpen: false,
        desktopOpen: false,

        openPanel() {
            this.panelOpen = true;
            this.desktopOpen = false;
        },
        toggleDesktop() {
            this.desktopOpen = !this.desktopOpen;
            this.panelOpen = false;
        },
        closeAll() {
            this.panelOpen = false;
            this.desktopOpen = false;
        },
    }
}

window.addEventListener(
    'alpine:init',
    () => Alpine.data(
        'initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>',
        initLanguageSwitcher<?= $escaper->escapeHtml($uniqueId) ?>
    ),
    { once: true }
);
</script>

<?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>
