<?php
declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Store;
use Hyva\Theme\ViewModel\StoreSwitcher;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Store\ViewModel\SwitcherUrlProvider;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

$switcherUrlProvider = $viewModels->require(SwitcherUrlProvider::class);
$storeViewModel = $viewModels->require(Store::class);
$storeSwitcherViewModel = $viewModels->require(StoreSwitcher::class);

$currentStore = $storeSwitcherViewModel->getStore();
$stores = $storeSwitcherViewModel->getStores();

$normalizeFlagCode = static function (string $storeCode): string {
    $code = strtolower(trim($storeCode));
    $code = str_replace('-', '_', $code);
    $parts = array_values(array_filter(explode('_', $code)));
    if (!$parts) return 'en';

    $last = end($parts);
    if (preg_match('/^[a-z]{2}$/', (string) $last)) {
        return (string) $last; // sk, cz, de...
    }
    $fallback = substr((string) $parts[0], 0, 2);
    return $fallback ?: 'en';
};

$countryLabelFromFlag = static function (string $flagCode): string {
    $map = [
        // ðŸ‡¸ðŸ‡°
        'sk' => 'Slovensko',

        // ðŸ‡¨ðŸ‡¿
        'cz' => 'ÄŒesko',
        'cs' => 'ÄŒesko',

        // ðŸ‡©ðŸ‡ª
        'de' => 'Deutschland',

        // ðŸ‡¦ðŸ‡¹
        'at' => 'Ã–sterreich',

        // ðŸ‡­ðŸ‡º
        'hu' => 'MagyarorszÃ¡g',

        // ðŸ‡µðŸ‡±
        'pl' => 'Polska',

        // ðŸ‡·ðŸ‡´
        'ro' => 'RomÃ¢nia',

        // ðŸ‡®ðŸ‡¹
        'it' => 'Italia',

        // ðŸ‡«ðŸ‡·
        'fr' => 'France',

        // ðŸ‡ªðŸ‡¸
        'es' => 'EspaÃ±a',

        // ðŸ‡³ðŸ‡±
        'nl' => 'Nederland',

        // ðŸ‡§ðŸ‡ª
        'be' => 'BelgiÃ«',

        // ðŸ‡©ðŸ‡°
        'dk' => 'Danmark',

        // ðŸ‡¸ðŸ‡ª
        'se' => 'Sverige',

        // ðŸ‡«ðŸ‡®
        'fi' => 'Suomi',

        // ðŸ‡®ðŸ‡ª
        'ie' => 'Ireland',

        // ðŸ‡µðŸ‡¹
        'pt' => 'Portugal',

        // ðŸ‡¬ðŸ‡·
        'gr' => 'Î•Î»Î»Î¬Î´Î±',
        'el' => 'Î•Î»Î»Î¬Î´Î±',

        // ðŸ‡§ðŸ‡¬
        'bg' => 'Ð‘ÑŠÐ»Ð³Ð°Ñ€Ð¸Ñ',

        // ðŸ‡­ðŸ‡·
        'hr' => 'Hrvatska',

        // ðŸ‡¸ðŸ‡®
        'si' => 'Slovenija',

        // ðŸ‡ªðŸ‡ª
        'ee' => 'Eesti',

        // ðŸ‡±ðŸ‡»
        'lv' => 'Latvija',

        // ðŸ‡±ðŸ‡¹
        'lt' => 'Lietuva',

        // ðŸ‡±ðŸ‡º
        'lu' => 'Luxembourg',

        // ðŸ‡²ðŸ‡¹
        'mt' => 'Malta',

        // ðŸ‡¨ðŸ‡¾
        'cy' => 'ÎšÏÏ€ÏÎ¿Ï‚',
    ];
    return $map[$flagCode] ?? strtoupper($flagCode);
};

$shortCodeFromFlag = static function (string $flagCode): string {
    // SK/CZ/DE...
    return strtoupper($flagCode);
};

// Figma-like: images/flags/sk1.svg...
$flagSvgUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/' . $flagCode . '1.svg');
};

// Fallback na PNG (ak svg nie je)
$flagPngUrl = static function (string $flagCode) use ($block): string {
    return $block->getViewFileUrl('images/flags/circle/' . $flagCode . '.png');
};

$domainFromUrl = static function (string $url): string {
    $host = parse_url($url, PHP_URL_HOST);
    return $host ?: $url;
};

$currentFlagCode = $normalizeFlagCode((string) $currentStore->getCode());
$currentShort    = $shortCodeFromFlag($currentFlagCode);

$uniqueId = '_' . uniqid();
?>

<?php if (count($stores) > 1): ?>
<div
    x-data="initLanguageDropdown<?= $escaper->escapeHtml($uniqueId) ?>()"
    class="relative inline-flex"
>
    <!-- MOBILE: flag only -->
    <div class="relative md:hidden">
        <button
            type="button"
            class="p-2 rounded-lg bg-gray-100 hover:bg-gray-200 transition-colors"
            @click.prevent="toggle()"
            @keydown.window.escape="close()"
            aria-haspopup="true"
            :aria-expanded="open ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />
        </button>
    </div>

    <!-- DESKTOP: flag + SK + chevron -->
    <div class="relative hidden md:block lg:block">
        <button
            type="button"
            class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-gray-50 transition-colors border border-gray-200"
            @click.prevent="toggle()"
            @keydown.window.escape="close()"
            aria-haspopup="true"
            :aria-expanded="open ? 'true' : 'false'"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language: %1', $currentStore->getName())) ?>"
        >
            <img
                src="<?= $escaper->escapeUrl($flagSvgUrl($currentFlagCode)) ?>"
                onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($currentFlagCode)) ?>';"
                alt="<?= $escaper->escapeHtmlAttr($currentStore->getName()) ?>"
                class="w-5 h-5 rounded-full object-cover"
                width="20"
                height="20"
                loading="lazy"
                decoding="async"
            />

            <span class="text-gray-600 text-sm font-medium">
                <?= $escaper->escapeHtml($currentShort) ?>
            </span>

            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                 class="w-3.5 h-3.5 text-gray-500 transition-transform"
                 :class="open ? 'rotate-180' : ''"
                 aria-hidden="true">
                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
        </button>
    </div>

    <!-- Backdrop -->
    <div
        x-cloak
        x-show="open"
        class="fixed inset-0 z-40"
        @click="close()"
        aria-hidden="true"
    ></div>

    <!-- Dropdown -->
    <div
        x-cloak
        x-show="open"
        x-transition.origin.top.right
        class="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50 overflow-hidden"
        role="menu"
        aria-label="<?= $escaper->escapeHtmlAttr(__('Choose your language')) ?>"
    >
        <div class="px-3 py-2 border-b border-gray-100">
            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
                <?= $escaper->escapeHtml(__('Select country')) ?>
            </p>
        </div>

        <div class="py-1">
            <?php foreach ($stores as $lang): ?>
                <?php
                $isCurrent = ((int) $lang->getId() === (int) $storeViewModel->getStoreId());

                $langFlagCode = $normalizeFlagCode((string) $lang->getCode());
                $langUrl = (string) $switcherUrlProvider->getTargetStoreRedirectUrl($lang);
                $langDomain = $domainFromUrl($langUrl);

                $countryLabel = $countryLabelFromFlag($langFlagCode);
                ?>
                <?php if ($isCurrent): ?>
                    <div
                        class="flex items-center gap-3 px-4 py-2.5 opacity-60 cursor-default"
                        role="menuitem"
                        aria-current="true"
                    >
                        <img
                            src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                            onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                            alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                            class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-gray-200"
                            width="24"
                            height="24"
                            loading="lazy"
                            decoding="async"
                        />
                        <div class="flex-1">
                            <div class="font-medium text-gray-900 text-sm">
                                <?= $escaper->escapeHtml($countryLabel) ?>
                            </div>
                            <div class="text-xs text-gray-500">
                                <?= $escaper->escapeHtml($langDomain) ?>
                            </div>
                        </div>

                        <!-- napravo zobrazime SK/CZ/DE pre current -->
                        <span class="text-xs font-semibold text-gray-500">
                            <?= $escaper->escapeHtml($shortCodeFromFlag($langFlagCode)) ?>
                        </span>
                    </div>
                <?php else: ?>
                    <a
                        href="<?= $escaper->escapeUrl($langUrl) ?>"
                        class="flex items-center gap-3 px-4 py-2.5 transition-colors group hover:bg-gray-50"
                        role="menuitem"
                        @click="close()"
                        @mouseenter="$el.style.backgroundColor = '#f0f4f1'"
                        @mouseleave="$el.style.backgroundColor = ''"
                    >
                        <img
                            src="<?= $escaper->escapeUrl($flagSvgUrl($langFlagCode)) ?>"
                            onerror="this.onerror=null;this.src='<?= $escaper->escapeJs($flagPngUrl($langFlagCode)) ?>';"
                            alt="<?= $escaper->escapeHtmlAttr($lang->getName()) ?>"
                            class="w-6 h-6 rounded-full object-cover shadow-sm ring-1 ring-gray-200"
                            width="24"
                            height="24"
                            loading="lazy"
                            decoding="async"
                        />

                        <div class="flex-1">
                            <div class="font-medium text-gray-900 text-sm">
                                <?= $escaper->escapeHtml($countryLabel) ?>
                            </div>
                            <div class="text-xs text-gray-500">
                                <?= $escaper->escapeHtml($langDomain) ?>
                            </div>
                        </div>

                        <!-- chevron right -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                             class="w-4 h-4 -rotate-90 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"
                             @mouseenter="$el.style.color = '#7e9b84'"
                             @mouseleave="$el.style.color = ''"
                             aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                    </a>
                <?php endif; ?>
            <?php endforeach; ?>
        </div>
    </div>
</div>

<script>
'use strict';
function initLanguageDropdown<?= $escaper->escapeHtml($uniqueId) ?>() {
    return {
        open: false,
        toggle() { this.open = !this.open; },
        close() { this.open = false; },
    }
}
window.addEventListener(
    'alpine:init',
    () => Alpine.data(
        'initLanguageDropdown<?= $escaper->escapeHtml($uniqueId) ?>',
        initLanguageDropdown<?= $escaper->escapeHtml($uniqueId) ?>
    ),
    { once: true }
);
</script>

<?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>
