<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2020-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HeroiconsOutline;
use Hyva\Theme\ViewModel\HyvaCsp;
use Hyva\Theme\ViewModel\Store;
use Hyva\Theme\ViewModel\StoreSwitcher;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Store\ViewModel\SwitcherUrlProvider;

/** @var Template $block */
/** @var Escaper $escaper */
/** @var HyvaCsp $hyvaCsp */
/** @var ViewModelRegistry $viewModels */

/** @var SwitcherUrlProvider $switcherUrlProvider */
$switcherUrlProvider = $viewModels->require(SwitcherUrlProvider::class);

/** @var Store $storeViewModel */
$storeViewModel = $viewModels->require(Store::class);

/** @var StoreSwitcher $storeSwitcherViewModel */
$storeSwitcherViewModel = $viewModels->require(StoreSwitcher::class);

/** @var HeroiconsOutline $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

$currentStore = $storeSwitcherViewModel->getStore();
?>
<?php if (count($storeSwitcherViewModel->getStores()) > 1): ?>
    <div x-data="initLanguageSwitcher" class="relative">
        <button
            @click.prevent="toggleOpen"
            @click.outside="setOpenFalse"
            @keydown.window.escape="setOpenFalse"
            type="button"
            class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors"
            aria-haspopup="true"
            :aria-expanded="open ? 'true' : 'false'"
        >
            <span class="truncate max-w-[140px]"><?= $escaper->escapeHtml($currentStore->getName()) ?></span>
            <?= $heroicons->chevronDownHtml('text-gray-500', 16, 16, ['aria-hidden' => 'true']) ?>
        </button>

        <nav
            class="absolute right-0 z-20 w-56 py-2 mt-2 overflow-auto origin-top-right rounded-xl shadow-xl border border-gray-200 bg-white"
            x-cloak
            x-show="open"
            aria-label="<?= $escaper->escapeHtmlAttr(__('Language')) ?>"
        >
            <div class="px-3 py-2 border-b border-gray-100">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
                    <?= $escaper->escapeHtml(__('Select store')) ?>
                </p>
            </div>
            <div class="py-1" role="menu" aria-orientation="vertical">
                <?php foreach ($storeSwitcherViewModel->getStores() as $lang): ?>
                    <?php if ($lang->getId() != $storeViewModel->getStoreId()): ?>
                        <a
                            href="<?= $escaper->escapeUrl($switcherUrlProvider->getTargetStoreRedirectUrl($lang)) ?>"
                            class="flex items-center gap-3 px-4 py-2.5 text-sm text-gray-700 hover:bg-gray-50 transition-colors"
                            role="menuitem"
                        >
                            <span class="font-medium"><?= $escaper->escapeHtml($lang->getName()) ?></span>
                            <span class="text-xs text-gray-500"><?= $escaper->escapeHtml($lang->getCode()) ?></span>
                        </a>
                    <?php endif; ?>
                <?php endforeach; ?>
            </div>
        </nav>
    </div>

    <script>
        function initLanguageSwitcher() {
            return hyva.createBooleanObject('open')
        }
        window.addEventListener('alpine:init', () => Alpine.data('initLanguageSwitcher', initLanguageSwitcher), {once: true})
    </script>
    <?php $hyvaCsp->registerInlineScript() ?>
<?php endif; ?>
