<?php
declare(strict_types=1);

use Magento\Catalog\Block\Product\ProductList\Toolbar;
use Magento\Framework\Escaper;
use Hyva\Theme\ViewModel\HyvaCsp;

/** @var Escaper $escaper */
/** @var Toolbar $block */
/** @var HyvaCsp $hyvaCsp */

$widgetOptionsJson = (string) $block->getWidgetOptionsJson(['page' => 'p']); // JSON string

$orders = (array) $block->getAvailableOrders();
$currentOrderCode = (string) ($block->getCurrentOrder() ?: $block->getDefaultOrder());

$uniqueId = '_' . uniqid();
$dialogId = 'sort_drawer' . $uniqueId;

$rangeText = sprintf(
    'Zobrazuje sa %d–%d z %d',
    (int) $block->getFirstNum(),
    (int) $block->getLastNum(),
    (int) $block->getTotalNum()
);
?>
<script>
  function initToolbar<?= $escaper->escapeHtml($uniqueId) ?>() {
    return {
      options: {},
      open: false,

      get isDesktop() {
        return window.matchMedia('(min-width: 768px)').matches;
      },

      init() {
        this.options = this.setAdditionalOptions(this.$root.dataset.options);
      },

      toggle() {
        this.open = !this.open;
        if (this.open) {
          this.$nextTick(() => {
            try { this.$refs.dialog?.showModal?.(); } catch(e) {}
          });
        } else {
          this.close();
        }
      },

      close() {
        this.open = false;

        // nechaj prebehnúť x-transition (duration-300)
        window.setTimeout(() => {
          try { this.$refs.dialog?.close?.(); } catch(e) {}
          this.$refs.mobileTrigger?.focus?.();
        }, 320);
      },
      openDrawer() {
        this.open = true;
        this.$nextTick(() => {
          try { this.$refs.dialog?.showModal?.(); } catch(e) {}
        });
      },
      onBackdropClick(event) {
        if (event.target === this.$refs.dialog) {
          this.close();
        }
      },

      setAdditionalOptions(json) {
        if (!json) return {};
        try {
          const options = JSON.parse(json);
          if (typeof options.productListToolbarForm === 'object') {
            return options.productListToolbarForm;
          }
        } catch(e) {}
        return {};
      },

      getUrlParams() {
        const d = decodeURIComponent;
        const url = this.options.url || location.href;
        const parts = url.split('?');
        const params = (parts[1] ? parts[1].split('&') : []).reduce((acc, kv) => {
          const p = kv.split('=');
          acc[d(p[0])] = p[1] !== undefined ? d(p[1].replace(/\+/g, '%20')) : '';
          return acc;
        }, {});
        return params;
      },

      changeUrl(paramName, paramValue, defaultValue) {
        const url = this.options.url || location.href;
        const parts = url.split('?');
        const base  = parts[0];
        let   data  = this.getUrlParams();

        data[paramName] = paramValue;

        if (this.options.post && typeof hyva !== 'undefined' && hyva.postForm) {
          hyva.postForm({action: base, data, skipUenc: true});
        } else {
          if (String(paramValue) === String(defaultValue)) delete data[paramName];
          const query = Object.keys(data).length ? ('?' + new URLSearchParams(data)) : '';
          location.href = base + query;
        }
      },

      // kompatibilné s viewmode template tlačidlami (data-value)
      changeListMode(e) {
        const target = e?.currentTarget || e?.target;
        const mode = target?.dataset?.value || target?.dataset?.listMode || target?.dataset?.listModeValue;
        if (!mode) return;

        const paramName = this.options.mode || 'product_list_mode';
        const defaultVal = this.options.modeDefault || '';
        this.changeUrl(paramName, mode, defaultVal);
      }
    }
  }

  window.addEventListener(
    'alpine:init',
    () => Alpine.data('initToolbar<?= $escaper->escapeHtml($uniqueId) ?>', initToolbar<?= $escaper->escapeHtml($uniqueId) ?>),
    { once: true }
  );
</script>
<?php $hyvaCsp->registerInlineScript(); ?>

<?php if ($block->getCollection()->getSize()): ?>
  <?php if ($block->getIsBottom()): ?>
    <div x-data="initToolbar<?= $escaper->escapeHtml($uniqueId) ?>()"
         data-options="<?= $escaper->escapeHtmlAttr($widgetOptionsJson) ?>"
         class="toolbar toolbar-products mt-8">
      <?= /* @noEscape */ $block->getPagerHtml() ?>
    </div>
  <?php else: ?>

    <div x-data="initToolbar<?= $escaper->escapeHtml($uniqueId) ?>()"
         data-options="<?= $escaper->escapeHtmlAttr($widgetOptionsJson) ?>"
         class="toolbar toolbar-products  pt-0 pb-0 mb-4">

      <!-- DESKTOP -->
     <?php if ($block->isExpanded()): ?>
       <!-- Full-width section (border cez celú obrazovku) -->
       <section
         class="relative w-screen left-1/2 right-1/2 -ml-[50vw] -mr-[50vw] pb-8 bg-white border-b border-gray-200 overflow-visible "
       >
         <!-- vnútorný kontajner: žiadny "container", iba max width -->
         <div class="max-w-7xl mx-auto overflow-visible ">
           <?= $block->fetchView(
               $block->getTemplateFile('Magento_Catalog::product/list/toolbar/sorter.phtml')
           ) ?>
         </div>
       </section>
     <?php endif; ?>


     

    </div>

  <?php endif; ?>
<?php endif; ?>
