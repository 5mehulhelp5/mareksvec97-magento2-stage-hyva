<?php
/**
 * Topfero / Hyvä – Review Summary (SHORT) – Prototype style
 *
 * Override path:
 * app/design/frontend/Topfero/hyva/Magento_Review/templates/helper/summary_short.phtml
 */

declare(strict_types=1);

use Magento\Framework\Escaper;
use Magento\Review\Block\Product\ReviewRenderer;

/** @var ReviewRenderer $block */
/** @var Escaper $escaper */

$ratingPercent = (float) $block->getRatingSummary(); // 0..100
$ratingSteps   = 5;

$ratingValue = $ratingPercent > 0
    ? ($ratingPercent / 100) * $ratingSteps
    : 0.0;

// Prototype: len plné vs prázdne hviezdy (bez polovičných)
$starsFilled = (int) floor($ratingValue);
$starsFilled = max(0, min($ratingSteps, $starsFilled));
$starsEmpty  = $ratingSteps - $starsFilled;

// Text v zátvorke ako v prototype: (5) alebo (4.8)
$ratingLabel = $ratingValue > 0
    ? rtrim(rtrim(number_format($ratingValue, 1, '.', ''), '0'), '.')
    : '0';

$productName = (string) $block->getProduct()->getName();
$productId   = (int) $block->getProduct()->getId();
$uniqueId    = $productId . uniqid('', true);
?>

<?php if ($block->isReviewEnabled()): ?>
    <div
        x-data="initRating<?= /* @noEscape */ preg_replace('/[^a-zA-Z0-9_]/', '_', (string) $uniqueId) ?>()"
        x-defer="intersect"
        @keyup.enter="scrollToRatings()"
        @click="scrollToRatings()"
        class="flex items-center gap-1 mb-3"
        :class="{'cursor-pointer': reviewsSection}"
        <?php if (!$ratingPercent): ?>
            title="<?= $escaper->escapeHtmlAttr(__('Be the first to review this product')) ?>"
        <?php endif; ?>
        :tabindex="reviewsSection ? '0' : '-1'"
        :aria-label="reviewsSection
            ? '<?= $escaper->escapeJs(__('%1 rating. %2 out of %3 stars. Click to go to reviews.', $productName, $ratingLabel, $ratingSteps)) ?>'
            : '<?= $escaper->escapeJs(__('%1 rating. %2 out of %3 stars', $productName, $ratingLabel, $ratingSteps)) ?>'
        "
        :role="reviewsSection ? 'button' : 'img'"
    >
        <div class="flex items-center gap-1" aria-hidden="true">
            <?php if ($ratingPercent): ?>
                <?php for ($i = 0; $i < $starsFilled; $i++): ?>
                    <!-- filled -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         class="w-4 h-4 fill-yellow-400 text-yellow-400">
                        <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                    </svg>
                <?php endfor; ?>

                <?php for ($i = 0; $i < $starsEmpty; $i++): ?>
                    <!-- empty -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                    </svg>
                <?php endfor; ?>

                <span class="text-xs text-muted ml-1">(<?= $escaper->escapeHtml($ratingLabel) ?>)</span>
            <?php else: ?>
                <?php for ($i = 0; $i < $ratingSteps; $i++): ?>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                         class="w-4 h-4 text-gray-200" fill="none" stroke="currentColor"
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
                    </svg>
                <?php endfor; ?>
            <?php endif; ?>
        </div>
    </div>

    <script>
        'use strict';

        function initRating<?= /* @noEscape */ preg_replace('/[^a-zA-Z0-9_]/', '_', (string) $uniqueId) ?>() {
            return {
                reviewsSection: document.getElementById('customer-review-list')
                    || document.getElementById('customer-reviews')
                    || document.getElementById('review-form'),
                scrollToRatings() {
                    let scrollTimeout = null;

                    if (!this.reviewsSection) {
                        return;
                    }

                    addEventListener('scroll', () => {
                        clearTimeout(scrollTimeout);

                        scrollTimeout = setTimeout(() => {
                            if (this.reviewsSection) {
                                this.reviewsSection.focus();
                            }
                        }, 50);
                    }, { once: true });

                    this.reviewsSection.scrollIntoView({ behavior: 'smooth' });
                }
            }
        }
    </script>
<?php endif; ?>
