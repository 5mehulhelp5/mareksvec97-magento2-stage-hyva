<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2022-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var Escaper $escaper */
/** @var Template $block */
/** @var HyvaCsp $hyvaCsp */
?>
<script>
    (() => {
        let currentHistoryStep = null

        window.addEventListener('checkout:step:loaded', event => {
            const step = event.detail || null

            if (currentHistoryStep === null || step.position !== currentHistoryStep.position) {
                if (currentHistoryStep === null) {
                    window.history.replaceState({ step: step }, '', window.location.href)
                } else if (step.route !== currentHistoryStep.route) {
                    window.history.pushState({ step: step }, '', '<?= $escaper->escapeJs(
                        $block->getUrl('checkout/*/index', ['_current' => true, 'step' => 'STEP_PLACEHOLDER'])
                    ) ?>'.replace('STEP_PLACEHOLDER', step.route))
                }

                currentHistoryStep = step
            }
        })

        window.addEventListener('popstate', event => {
            if (event.state === null) {
                return
            }

            const step = event.state.step || null

            if (step && currentHistoryStep.position !== step.position) {
                hyvaCheckout.navigation.stepTo(step.route, false)
                currentHistoryStep = step
            }
        })
    })()
</script>
<?php $hyvaCsp->registerInlineScript() ?>
