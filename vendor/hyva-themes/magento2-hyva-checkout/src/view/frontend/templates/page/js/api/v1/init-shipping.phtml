<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2022-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\View\Element\Template;

/** @var Template $block */
/** @var HyvaCsp $hyvaCsp */

/**
 * @Internal Prefer utilizing the "after" container for injecting additional code.
 */
?>
<script>
    (() => {
        window.addEventListener('checkout:init:shipping', () => {
            <?php /* Global listener for when the shipping method was updated. */ ?>
            window.addEventListener('shipping:method:update', event => {
                if ('method' in event.detail) {
                    hyvaCheckout.shipping.activate(event.detail.method)
                }
            })
        })

        <?php /* Handles shipping method activation. */ ?>
        window.addEventListener('magewire:available', () => {
            const checkoutShippingMethodActivate = method => {
                if (method) {
                    window.dispatchEvent(new CustomEvent('checkout:shipping:method-activate', {
                        detail: {
                            method: method
                        }
                    }))
                }
            }

            <?php /* 1. Activate the shipping method when the Magewire component emitted the updated event. */ ?>
            window.addEventListener('checkout:init:evaluation', () => {
                Magewire.on('shipping_method_selected', event => checkoutShippingMethodActivate(event.code))
            })

            <?php /* 2. Activate the shipping method when the Magewire component is initialized on the page. */ ?>
            Magewire.hook('component.initialized', component => {
                if (component.id === 'checkout.shipping.methods') {
                    checkoutShippingMethodActivate(component.data.method)
                }
            })
        })
    })()
</script>
<?php $hyvaCsp->registerInlineScript() ?>

<?= $block->getChildHtml('after') ?>
