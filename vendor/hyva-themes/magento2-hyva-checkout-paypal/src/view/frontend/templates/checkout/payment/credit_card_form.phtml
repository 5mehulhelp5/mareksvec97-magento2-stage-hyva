<?php
/**
 * Hyvä Themes - https://hyva.io
 * Copyright © Hyvä Themes 2022-present. All rights reserved.
 * This product is licensed per Magento install
 * See https://hyva.io/license
 */

declare(strict_types=1);

use Hyva\CheckoutPayPal\ViewModel\Payment\CreditCardForm as ViewModel;
use Hyva\Theme\Model\ViewModelRegistry;
use Magento\Framework\Escaper;
use Magento\Payment\Block\Form\Cc;
use Hyva\CheckoutPayPal\ViewModel\PaypalIcons;
use Hyva\Theme\ViewModel\HeroiconsOutline;

/** @var Escaper $escaper */
/** @var Cc $block */
/** @var ViewModelRegistry $viewModels */
/** @var ViewModel $viewModel */

$code = $block->getMethodCode();

/** @var PaypalIcons $svgIcons */
$paypalIconsSvgIcons = $viewModels->require(PaypalIcons::class);

/** @var Hyva\Theme\ViewModel\HeroiconsSolid $heroicons */
$heroicons = $viewModels->require(HeroiconsOutline::class);

$ccAvailableTypes = $block->getCcAvailableTypes();
$viewModel = $viewModels->require(ViewModel::class);
$creditCardTypesJsConfig = $viewModel->getCreditCardTypesJsConfig(array_keys($ccAvailableTypes));
// phpcs:disable Generic.Files.LineLength.TooLong
?>

<div class="pp-card-form card rounded-lg">
    <form id="card-form-<?= $escaper->escapeHtmlAttr($code) ?>">
        <div class="pp-card-number mb-4 font-medium text-gray-700 required">
            <label for="<?= /* @noEscape */ $code ?>_cc_number">
                <span><?= $escaper->escapeHtml(__('Credit Card Number')) ?></span>
            </label>

            <div class="flex items-center gap-4">
                <input type="tel"
                       id="<?= /* @noEscape */ $code ?>_cc_number"
                       data-container="<?= /* @noEscape */ $code ?>-cc-number"
                       name="payment[cc_number]"
                       title="<?= $escaper->escapeHtmlAttr(__('Credit Card Number')) ?>"
                       class="form-input pp-number-input w-full"
                       value=""
                       autocomplete="cc-number"
                       inputmode="numeric"
                       pattern="[0-9\s\-]{13,19}"
                       maxlength="19"/>
            </div>
        </div>

        <div class="pp-card-date font-medium text-gray-700 mb-4 required">
            <label for="<?= /* @noEscape */ $code ?>_expiration">
                <span><?= $escaper->escapeHtml(__('Expiration Date')) ?></span>
            </label>

            <div class="flex flex-wrap items-center gap-4">
                <select id="<?= /* @noEscape */ $code ?>_expiration"
                        name="payment[cc_exp_month]"
                        data-container="<?= /* @noEscape */ $code ?>-cc-month"
                        class="form-input renderer-select pr-10 w-full sm:w-auto"
                        autocomplete="cc-exp-month"">
                    <?php foreach ($block->getCcMonths() as $monthValue => $monthLabel): ?>
                        <option value="<?= /* @noEscape */ $monthValue ? $escaper->escapeHtml($monthValue) : '' ?>">
                            <?= $escaper->escapeHtml($monthLabel) ?>
                        </option>
                    <?php endforeach ?>
                </select>

                <select id="<?= /* @noEscape */ $code ?>_expiration_yr"
                        name="payment[cc_exp_year]"
                        class="form-input renderer-select pr-10 w-full sm:w-auto"
                        data-container="<?= /* @noEscape */ $code ?>-cc-year"
                        autocomplete="cc-exp-year">
                    <?php foreach ($block->getCcYears() as $yearValue => $yearLabel): ?>
                        <option value="<?= /* @noEscape */ $yearValue ? $escaper->escapeHtml($yearValue) : '' ?>">
                            <?= $escaper->escapeHtml($yearLabel) ?>
                        </option>
                    <?php endforeach ?>
                </select>
            </div>
        </div>

        <?php if ($block->hasVerification()): ?>
            <div class="pp-card-cvv mb-4 font-medium text-gray-700 required">
                <label for="<?= /* @noEscape */ $code ?>_cc_cid">
                    <span><?= $escaper->escapeHtml(__('Card Verification Number')) ?></span>
                </label>

                <div class="flex items-center gap-4">
                    <input type="number"
                           title="<?= $escaper->escapeHtml(__('Card Verification Number')) ?>"
                           data-container="<?= /* @noEscape */ $code ?>-cc-cvv"
                           class="form-input cvv pp-number-input"
                           id="<?= /* @noEscape */ $code ?>_cc_cid"
                           name="payment[cc_cid]"
                           value=""
                           autocomplete="cc-csc"
                           maxlength="4"/>

                    <div class="pp-tooltip" x-data="PayPalCheckoutPaymentCreditCardFormToolTip">
                        <button
                            type="button"
                            x-bind="trigger"
                            class="block hover:cursor-pointer"
                        >
                            <?= $heroicons->questionMarkCircleHtml('', 24, 24, ['aria-hidden' => 'true']) ?>
                        </button>
                        <div class="tooltip relative" x-cloak x-show="showTooltip">
                            <div class="shadow-lg">
                                <div class="absolute -top-5 left-0 z-10 w-20 -mt-6 text-sm leading-tight text-black transform
                                            -translate-x-full md:-translate-x-1/3 -translate-y-full bg-white rounded-lg shadow-lg p-4">
                                    <span class="subtitle text-base">
                                        <?= $paypalIconsSvgIcons->renderHtml('cvv', "h-20 w-full"); ?>
                                    </span>
                                </div>
                                <svg class="absolute -top-5 left-6 z-10 w-8 h-8 text-white transform -translate-x-full
                                            -translate-y-8 fill-current stroke-current" width="12" height="12">
                                    <rect x="12" y="-12" width="12" height="12" transform="rotate(45)" class="shadow-xl" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </form>

    <div x-data="PaypalCreditCardForm"
         data-method-code="<?= $escaper->escapeHtmlAttr($code) ?>"
         data-available-types="<?= $escaper->escapeHtmlAttr(json_encode($ccAvailableTypes)) ?>"
         data-credit-card-config="<?= $escaper->escapeHtmlAttr($viewModel->getCreditCardTypesJsConfig(array_keys($ccAvailableTypes))); ?>"
    ></div>
</div>
